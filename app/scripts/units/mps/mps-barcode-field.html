<!--
@license
Copyright Â© HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../components/common/permanent-focus-input.html">
<link rel="import" href="../mps/mps-auto-popup.html">

<dom-module id="mps-barcode-field">
  <template>
    <style>

    </style>

    <permanent-focus-input id="input" timeout="2000" value="{{value}}">
    </permanent-focus-input>

    <mps-auto-popup id="popup"
      button-txt-callback="[[buttonTextCallback]]" hidden>
    </mps-auto-popup>
  </template>

  <script>
    class mpsBarcodeField extends Polymer.Element {
      static get is() { return 'mps-barcode-field'; }

      static get properties() {
        return {
          value: {
            type: String,
            notify: true
          },

          exceptCallAjaxRule: {
            type: Object
          },

          items: {
            type: Object,
            notify: true
            // observer: '_itemsChanged'
          },

          buttonTextCallback: {
            type: Object
          },

          selectedItem: {
            type: Object,
            notify: true
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
      }

      // _itemsChanged(items) {
      //   if (!items || items.length === 0) {
      //     return;
      //   }
      //   if (items.length > 1) {
      //     this.showPopup(items);
      //   } else {
      //     // do nothing
      //   }
      // }

      getValue() {
        return this.$.input.getValue();
      }

      select() {
        this.$.input.select();
      }

      focus() {
        this.$.input.focus();
      }

      reset() {
        this.value = null;
      }

      openPopup(items) {
        var popup = this.$.popup;
        popup.items = items;
        popup.hidden = false;

        var input = this.$.input;
        document.dispatchEvent(new CustomEvent('open-dialog', {
          detail: {
            content: popup,
            width: 'fit',
            height: 'fit',
            title: this.popupTitle,
            closeCallback: () => {
              if (popup.selectedItem) {
                this.selectedItem = [ popup.selectedItem ];
              } else {
                input.select();
              }

              popup.items = null;
              this._resetPopupContainer();
            }
          }
        }))
      }

      _resetPopupContainer() {
        var popup = this.$.popup;

        var container = popup.$.container;
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
      }
    }

    customElements.define(mpsBarcodeField.is, mpsBarcodeField);
  </script>

</dom-module>
