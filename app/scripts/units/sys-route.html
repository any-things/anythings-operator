<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<!-- <link rel="import" href="../../bower_components/iron-location/iron-query-params.html"> -->

<link rel="import" href="../mixins/things-locale-mounter.html">

<dom-module id="sys-route">
  <template>
    <style>
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}">
    </app-route>

  </template>
  <script>
    class SysRoute extends Polymer.mixinBehaviors([Things.LocaleMounter], Polymer.Element) {
    // class SysRoute extends mix(Polymer.Element).with(Things.LocaleMounter) {
      static get is() { return 'sys-route'; }

      static get properties() {
        return {
          route: {
            type: Object,
            notify: true,
            observer: '_routeChanged'
          },

          routeData: {
            type: Object
          },

          path: String,

          tail: String,

          title: {
            type: String,
            notify: true,
            readonly: true
          },

          page: {
            type: String,
            notify: true
          },

          loginSuccess: {
            type: Boolean,
            value: false
          },

          routePage: {
            type: Object,
            value: function() {
              return new Map([
                ['home', {title: 'menu.Home'}],
                ['login', {title: 'label.login'}],
                ['mps_setting', {title: 'menu.Settings'}]
              ])
            }
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        // 메뉴 정보가 변경 되었을 때 routePage(타이틀 정보)를 초기화 하기 위한 이벤트 핸들러 등록
        document.addEventListener('menu-info-changed', this._setRoutePage.bind(this));

        // 파라미터를 전달하며 라우팅을 변경하는 이벤트 리스너 등록
        document.addEventListener('page-change-with-params', event => {
          const dataObj = event.detail;
          const route = dataObj.route;
          const paramsKey = dataObj.paramsKey ? dataObj.paramsKey : 'routingParams';
          const params = dataObj.params;
          const app = document.querySelector('mps-operator-app');
          const ironPages = app.$['main'];
          const pageChangeEventHandler = function(event) {
            if(event.currentTarget.selectedItem) {
              event.currentTarget.selectedItem[paramsKey] = params;
              ironPages.removeEventListener('selected-item-changed', pageChangeEventHandler);
            }
          };

          ironPages.addEventListener('selected-item-changed', pageChangeEventHandler);

          location.hash = route.startsWith('/') ? route : '/' + route;
        });
      }

      /**
       * menu-info-changed event handler
       * 전달 받은 menu list를 통해 routePage의 값을 추가함
       */
      _setRoutePage(event) {
        const menus = event.detail;
        menus.forEach(menu => {
          this.routePage.set(menu.routing, {
            title: `menu.${menu.name}`
          });
        });

        if(!this.title || this.title.length <= 0) this._setTitle(this.page);
      }

      _routeChanged(route) {
        const oldPath = this.page;
        const newPath = route.path.replace('/', '')

        if(!route || oldPath === newPath) return;

        // 페이지 변경 전에 발생하는 이벤트
        const beforeChangeEvent = new CustomEvent('before-page-change', {
          detail: {
            prevPage: oldPath,
            currentPage: newPath
          },
          cancelable: true
        });

        if(document.dispatchEvent(beforeChangeEvent)) {
          this.path = newPath;
          if (newPath === "" || newPath === "/") {
            window.location.hash = "/home";
            return;
          } else {
            this.page = this.routeData.page;
            this._setTitle(this.page);
          }

          setTimeout(() => {
            // TODO: hash change 이후에 발생하도록 수정 현재 setTimeout 방식은 불안정적임
            document.dispatchEvent(new CustomEvent('page-changed', { detail: {
              prevPage: oldPath,
              currentPage: newPath
            }}));
          }, 100);
        }
      }

      _pageChanged(page) {
        this._page(page);
      }

      _showPage404() {
        this.toHome();
      }

      toHome() {
        this.route = {
          prefix: '',
          path: '/home'
        };
      }

      toLogin() {
        this.route = {
          prefix: '',
          path: '/login'
        };
      }

      /**
       * route가 변경되면 호출됨
       * this.routePage에서 page값을 통해 타이틀을 조회하고 다국어 처리 결과를
       * this.title에 초기화함
       */
      _setTitle(page) {
        if(this.routePage && this.routePage.size > 0) {
          let titleInfo = this.routePage.get(page);
          if(titleInfo && titleInfo.title) {
            this.title = t(titleInfo.title);
          } else {
            this.title = '';
          }
        }
      }

      // // FIXME
      // _getUrl() {
      //   var partiallyEncodedPath = window.encodeURI(
      //       this.path).replace(/\#/g, '%23').replace(/\?/g, '%3F');
      //   var partiallyEncodedQuery = '';
      //   if (this.query) {
      //     partiallyEncodedQuery = '?' + this.query.replace(/\#/g, '%23');
      //   }
      //   var partiallyEncodedHash = '';
      //   if (this.hash) {
      //     partiallyEncodedHash = '#' + window.encodeURI(this.hash);
      //   }
      //   return (
      //       partiallyEncodedPath + partiallyEncodedQuery + partiallyEncodedHash);
      // }
    }

    customElements.define(SysRoute.is, SysRoute);
  </script>
</dom-module>
