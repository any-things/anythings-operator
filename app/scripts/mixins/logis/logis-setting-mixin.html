<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<script>
  LogisSettingMixin = superClass => {
    return class LogisSettingMixin extends superClass {
      static get properties() {
        return {
          /**
           * @description 랙 라벨
           ****************
           * @type {String}
           */
          rackLabel: {
            type: String,
            value: () => t('label.rack_nm')
          },

          /**
           * @description 작업 라벨
           ****************
           * @type {String}
           */
          jobLabel: {
            type: String,
            value: () => t('label.job_type')
          },

          /**
           * @description 스테이션 라벨
           ****************
           * @type {String}
           */
          zoneLabel: {
            type: String,
            value: () => t('label.zone_cd')
          },

          /**
           * @description 작업 위치 라벨
           ****************
           * @type {String}
           */
          rackSideLabel: {
            type: String,
            value: () => t('label.rack_side')
          },

          /**
           * @description 왼쪽 라벨
           ****************
           * @type {String}
           */
          leftLabel: {
            type: String,
            value: () => t('label.left')
          },

          /**
           * @description 오른쪽 라벨
           ****************
           * @type {String}
           */
          rightLabel: {
            type: String,
            value: () => t('label.right')
          },

          /**
           * @description 앞쪽 라벨
           ****************
           * @type {String}
           */
          frontLabel: {
            type: String,
            value: () => t('label.front')
          },

          /**
           * @description 뒤쪽 라벨
           ****************
           * @type {String}
           */
          rearLabel: {
            type: String,
            value: () => t('label.rear')
          },

          /**
           * @description All 라벨
           ****************
           * @type {String}
           */
          allLabel: {
            type: String,
            value: () => t('label.all')
          },

          /**
           * @description 설비 타입 
           ****************
           * @type {String}
           */
          equipmentType: {
            type: String,
            value: () => JSON.parse(localStorage.getItem('setting.equipType'))
          },
          /**
           * @description 랙 코드
           ****************
           * @type {String}
           */
          rackCode: {
            type: String,
            value: () => JSON.parse(localStorage.getItem('setting.rackCd'))
          },




          /**
           * @description 랙 코드 로케일 키
           ****************
           * @type {String}
           */
          rackCodeLSKey: {
            type: String,
            value: 'setting.rackCd'
          },

          /**
           * @description 랙 이름
           ****************
           * @type {String}
           */
          rackName: {
            type: String
          },

          /**
           * @description 랙 이름 로케일 키
           ****************
           * @type {String}
           */
          rackNameLSKey: {
            type: String,
            value: 'setting.rackNm'
          },

          /**
           * @description 스테이션 코드
           ****************
           * @type {String}
           */
          stationCode: {
            type: String,
            value: () => JSON.parse(localStorage.getItem('setting.stationCd'))
          },

          /**
           * @description 스테이션 라벨 로케일 키
           ****************
           * @type {String}
           */
          stationCodeLSKey: {
            type: String,
            value: 'setting.stationCd'
          },

          /**
           * @description 작업 유형
           ****************
           * @type {String}
           */
          jobType: {
            type: String,
            value: () => JSON.parse(localStorage.getItem('setting.jobType'))
          },

          /**
           * @description 작업 이름 로케일 키
           ****************
           * @type {String}
           */
          jobTypeLSKey: {
            type: String,
            value: 'setting.jobType'
          },

          /**
           * @description 작업 위치
           ****************
           * @type {String}
           */
          rackSide: {
            type: String,
            //value: () => JSON.parse(localStorage.getItem('setting.rackSide'))
            value: () => 'ALL'
          },

          /**
           * @description 작업 위치 로케일 키
           ****************
           * @type {String}
           */
          rackSideLSKey: {
            type: String,
            value: 'setting.rackSide'
          },

          /**
           * @description 작업 위치 명
           ****************
           * @type {String}
           */
          rackSideName: {
            type: String
          },

          /**
           * @description 작업 위치 명 로케일 키
           ****************
           * @type {String}
           */
          rackSideNameLSKey: {
            type: String,
            value: 'setting.rackSideLabel'
          },

          /**
           * @description 업데이트 항목 리스트
           *********************
           * @type {Array}
           */
          updatedItems: {
            type: Array,
            observer: '_updatedItemsChanged'
          }
        }
      }

      /**
       * @description broker address를 조회
       *******************************
       * @return
       */
      _getBrokerAddress() {
        let brokerAddrsAjax = this._getBrokerAddrsAjax();
        brokerAddrsAjax.curl = '/settings/show_by_name?name=mw.rabbitmq.broker.address';
        brokerAddrsAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        brokerAddrsAjax.generateRequest();
      }

      /**
       * @description broker port를 조회
       *******************************
       * @return
       */
      _getBrokerPort() {
        let brokerPortAjax = this._getBrokerPortAjax();
        brokerPortAjax.curl = '/settings/show_by_name?name=mw.rabbitmq.web.mqtt.port';
        brokerPortAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        brokerPortAjax.generateRequest();
      }

      /**
       * @description broker site를 조회
       *******************************
       * @return
       */
      _getBrokerSite() {
        let brokerSiteAjax = this._getBrokerSiteAjax();
        brokerSiteAjax.curl = '/settings/show_by_name?name=mw.rabbitmq.site.code';
        brokerSiteAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        brokerSiteAjax.generateRequest();
      }

      /**
       * @description return broker-addrs-ajax
       *******************************
       * @return
       */
      _getBrokerAddrsAjax() {
        return this.$['broker-addrs-ajax'];
      }

      /**
       * @description return broker-port-ajax
       *******************************
       * @return
       */
      _getBrokerPortAjax() {
        return this.$['broker-port-ajax'];
      }

      /**
       * @description return broker-site-ajax
       *******************************
       * @return
       */
      _getBrokerSiteAjax() {
        return this.$['broker-site-ajax'];
      }

      /**
       * @description 조회한 broker address를 localStorage에 저장함
       *******************************
       */
      _setBrokerAddress(response) {
        if (response && response.detail) {
          localStorage.setItem('setting.brokerAddress', response.detail.value);
        }
      }

      /**
       * @description 조회한 broker port를 localStorage에 저장함
       *******************************
       */
      _setBrokerPort(response) {
        if (response && response.detail) {
          localStorage.setItem('setting.brokerPort', response.detail.value);
        }
      }

      /**
       * @description 조회한 broker site를 localStorage에 저장함
       *******************************
       */
      _setBrokerSite(response) {
        if (response && response.detail) {
          localStorage.setItem('setting.brokerSite', response.detail.value);
        }
      }

      /**
       * @description 스테이지 리스트를 조회
       *******************************
       * @return
       */
      _getStageList() {
        const stagesAjax = this._getStageListAjax();
        stagesAjax.curl = `/stages?limit=1000`;
        stagesAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        stagesAjax.generateRequest();
      }

      /**
       * @description 랙 리스트를 조회
       *******************************
       * @return
       */
      _getRackList() {
        const rackItemAjax = this._getRackListAjax();
        rackItemAjax.curl = `/racks?limit=1000`;
        rackItemAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        rackItemAjax.generateRequest();
      }

      /**
       * @description 스테이션 리스트를 조회
       *******************************
       * @return
       */
      _getStationList() {
        const selectedOption = this._getRackCombo().selectedOptions[0];
        if (selectedOption && selectedOption.value) {
          const rackCode = selectedOption.value;
          const stationListAjax = this._getStationListAjax();
          stationListAjax.curl = `/racks/${rackCode}/stations`;
          stationListAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
          stationListAjax.generateRequest();
        }
      }

      /**
       * @description 작업 유형 리스트 조회
       *******************************
       * @return
       */
      _getJobTypeList() {
        const jobTypeAjax = this._getJobTypesAjax();
        jobTypeAjax.curl = `/common_codes/show_by_name?name=JOB_TYPE`;
        jobTypeAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        jobTypeAjax.generateRequest();
      }

      /**
       * @description 설비 유형 리스트 조회
       *******************************
       * @return
       */
      _getEquipTypeList() {
        const equipmentItemAjax = this._getEquipTypeListAjax();
        equipmentItemAjax.curl = `/common_codes/show_by_name?name=EQUIP_TYPE`;
        equipmentItemAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        equipmentItemAjax.generateRequest();
      }

      /**
       * @description 콤보 클리어
       *******************************
       */
      _clearCombo(combo) {
        while (combo.childElementCount) {
          combo.removeChild(combo.firstElementChild);
        }
      }

      /**
       * @description key로 로컬 스토리지에서 뽑아냄
       *******************************
       * @return
       */
      _getLocalStorage(key) {
        return JSON.parse(localStorage.getItem(key));
      }

      /**
       * @description 로컬 스토리지에서 key, value로 저장
       *******************************
       */
      _setLocalStorage(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      /**
       * @description 체크한 옵션 값 리턴
       *******************************
       * @return
       */
      _getSelectedOpt(options) {
        return options.filter(option => {
          return option.checked
        })[0];
      }

      /**
       * @description 스테이지 리스트 조회 Ajax
       *******************************
       */
      _getStageListAjax() {
        return this.$['stages-ajax'];
      }

      /**
       * @description 설비 유형 리스트 Ajax
       *******************************
       */
      _getEquipTypeListAjax() {
        return this.$['equip-types-ajax'];
      }

      /**
       * @description 랙 리스트 조회 Ajax
       *******************************
       */
      _getRackListAjax() {
        return this.$['racks-ajax'];
      }

      /**
       * @description 스테이션 리스트 Ajax
       *******************************
       * @return
       */
      _getStationListAjax() {
        return this.$['stations-ajax'];
      }

      /**
       * @description 작업 유형 리스트 Ajax
       *******************************
       */
      _getJobTypesAjax() {
        return this.$['job-type-ajax'];
      }

      /**
       * @description return 작업 내역 보기 Ajax
       ***********************
       * @return {Object} ajax
       */
      _getUpdatedItemsAjax() {
        return this.$['update-ajax'];
      }

      /**
       * @description 업데이트 세팅 ajax 리턴
       *******************************
       * @return
       */
      _getUpdateSettingAjax() {
        return this.$['update-setting-ajax'];
      }

      /**
       * @description 스테이지 리스트 콤보 리턴
       *******************************
       * @return
       */
      _getStageCombo() {
        return this.$['stage-combo'];
      }

      /**
       * @description 설비 유형 리스트 콤보 리턴
       *******************************
       */
      _getEquipTypeCombo() {
        return this.$['equip-type-combo'];
      }

      /**
       * @description 설비 리스트 콤보 리턴 -> TODO 설비 유형에 따른 설비 리스트를 조회하도록 변경
       *******************************
       * @return
       */
      _getRackCombo() {
        return this.$['rack-combo'];
      }

      /**
       * @description 작업 스테이션 리스트 콤보 리턴
       *******************************
       */
      _getStationCombo() {
        return this.$['station-combo'];
      }

      /**
       * @description 작업 유형 리스트 콤보 리턴
       *******************************
       * @return
       */
      _getJobTypeCombo() {
        return this.$['job-type-combo'];
      }

      /**
       * @description 업데이트 리스트 변경 시 ...
       **********************
       * @param {Array} updatedItems
       */
      _updatedItemsChanged(updatedItems) {
        document.dispatchEvent(new CustomEvent('open-form-list-dialog', {
          detail: {
            title: t('title.patch_notes'),
            listFields: [{
              display: 'Seq.',
              fieldname: 'seq',
              columnWidth: '0.7fr',
              style: {
                textAlign: 'center'
              }
            }, {
              display: 'Content',
              fieldname: 'content',
              columnWidth: '2fr'
            }],
            listData: updatedItems
          }
        }));
      }

      /**
       * @description 작업 위치 (사이드 코드) 값 리턴
       *******************************
       * @return
       */
      _getRackSideOpts() {
        //return Array.from(this.$['rack-side'].querySelectorAll('input[name=rack-side]'));
        return ['ALL'];
      }

      /**
       * @description 작업 위치 (사이드 코드) 콤보 렌더링
       *******************************
       */
      _setRackSideDefaultValue() {
        /*const rackSideOpts = this._getRackSideOpts();
        rackSideOpts.forEach(rackSideOpt => {
          if (this.rackSide === rackSideOpt.value) {
            rackSideOpt.checked = true;
          }
        });*/

        this.rackSide = 'ALL';
      }

      /**
       * @description 스테이지 콤보 렌더링
       *******************************
       */
      _renderStageCombo(event) {
        const stageCombo = this._getStageCombo();
        this._clearCombo(stageCombo);
        let stages = event.detail.items;

        if (stages) {
          stages.forEach(stage => {
            const option = new Option(stage.stage_cd, stage.stage_nm);
            if (this.stageCode === stage.stage_cd) {
              option.selected = true;
            }

            stageCombo.appendChild(option);
          })
        }
      }

      /**
       * @description 설비 유형 콤보 렌더링
       *******************************
       * @param {Object} event
       */
      _renderEquipTypeCombo(event) {
        const equipTypeCombo = this._getEquipTypeCombo();
        this._clearCombo(equipTypeCombo);
        let equipTypes = event.detail.items;

        equipTypes.forEach(equipType => {
          const option = new Option(equipType.description, equipType.name);
          if (this.equipmentType === equipType.name) {
            option.selected = true;
            this.equipmentType = equipType.name;
          }

          equipTypeCombo.appendChild(option);
        })
      }

      /**
       * @description 랙 콤보 렌더링
       *******************************
       * @param {Object} event
       */
      _renderRackCombo(event) {
        const rackCombo = this._getRackCombo();
        this._clearCombo(rackCombo);

        if (event && event.detail) {
          event.detail.items.forEach(rack => {
            const option = new Option(rack.rack_nm, rack.rack_cd);
            if (this.rackCode === rack.rack_cd) {
              option.selected = true;
              this.rackName = rack.rack_nm;
            }

            rackCombo.appendChild(option);
          });
        }

        if (this.deviceType !== 'KIOSK') {
          this._getStationList();
        }

        this._getStationList();
      }

      /**
       * @description 작업 스테이션 콤보 렌더링
       *******************************
       * @param {Object} event
       */
      _renderStationCombo(event) {
        const stationCombo = this._getStationCombo();
        this._clearCombo(stationCombo);

        if (event && event.detail) {
          event.detail.forEach(station => {
            const option = new Option(station, station);
            if (this.stationCode === station) {
              option.selected = true;
            }

            stationCombo.appendChild(option);
          })
        }
      }

      /**
       * @description 작업 유형 콤보 렌더링
       *******************************
       * @param {Object} event
       */
      _renderJobTypeCombo(event) {
        const jobTypeCombo = this._getJobTypeCombo();
        if (jobTypeCombo) {
          this._clearCombo(jobTypeCombo);
          let jobTypes = event.detail.items;

          jobTypes.forEach(job => {
            const option = new Option(job.description, job.name);
            if (this.jobType === job.name) {
              option.selected = true;
              this.jobType = job.name;
            }

            jobTypeCombo.appendChild(option);
          })
        }
      }

      /**
       * @description 업데이트 내역 보기
       **********************
       * @param {Object} event
       */
      _viewUpdateContent(event) {
        const deviceType = localStorage.getItem('setting.deviceType');
        const updatedItemsAjax = this._getUpdatedItemsAjax();
        updatedItemsAjax.curl = '/device_process/release_notes/' + deviceType;
        updatedItemsAjax.baseUrl = this._getLocalStorage('setting.baseUrl');
        updatedItemsAjax.generateRequest();
      }

      /**
      * @description web view cache clear
      **************************
      * windows에 CacheClear가 있다면 (cordova plugin 사용 가능한 상태)
      * webview cache를 클리어한 후 리로드
      * 없을 경우 리로드
      */
      reloadApp() {
        if ('CacheClear' in window) {
          window.CacheClear(() => {
            location.reload(true);
          });
        } else {
          location.reload(true);
        }
      }
    }
  }
</script>