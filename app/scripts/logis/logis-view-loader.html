<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel='import' href='../../bower_components/polymer/polymer-element.html'>

<!--
  물류 > 화면 로더
-->
<dom-module id='logis-view-loader'>
  <script>
    class LogisViewLoader extends Polymer.Element {
      static get is() { return 'logis-view-loader' }

      static get properties() {
        return {
          commonElements: {
            type: Array,
            value: () => [{
              src: './scripts/components/sys/sys-route.html'
            }, {
              src: './scripts/fragments/sys/sys-setting.html'
            }, {
              src: './scripts/fragments/logis/logis-home.html'
            }, {
              src: './scripts/fragments/logis/logis-setting.html'
            }, {
              src: './scripts/fragments/common/any-login.html'
            }, {
              src: './scripts/components/logis/qrcode-popup.html'
            }]
          },

          viewElements: {
            type: Array,
            value: () => [{
              route: 'home',
              src: './scripts/fragments/logis/logis-home.html'
            }, {
              route: 'b2b_job_assort',
              src: './scripts/fragments/logis/b2b/assort/b2b-job-assort.html'
            }, {
              route: 'tab_das2_ord_info',
              src: './scripts/fragments/mps/tab/tab-das2-order-info.html'
            }, {
              route: 'b2c_picking_job',
              src: './scripts/fragments/logis/b2c/pick/b2c-picking-job.html'
            }, {
              route: 'tab_das_ord_list',
              src: './scripts/fragments/mps/tab/tab-das-order-list.html'
            }, {
              route: 'stock_status_by_cell',
              src: './scripts/fragments/logis/b2c/stock/stock-status-by-cell.html'
            }, {
              route: 'cell_stock_supplement',
              src: './scripts/fragments/logis/b2c/stock/cell-stock-supplement.html'
            }, {
              route: 'pda_stock_load_fixed',
              src: './scripts/fragments/logis/b2c/fixed-cell-stock-supplement.html'
            }, {
              route: 'pda_region_sku_info',
              src: './scripts/fragments/mps/pda/pda-region-sku-info.html'
            }, {
              route: 'b2b_assort_job',
              src: './scripts/fragments/logis/b2b/assort/b2b-assort-job.html'
            }, {
              route: 'pda_das2_process',
              src: './scripts/fragments/mps/pda/pda-das2-process.html'
            }, {
              route: 'pda_dps2_process',
              src: './scripts/fragments/mps/pda/pda-dps2-process.html'
            }, {
              route: 'b2b_rtn_assort_job',
              src: './scripts/fragments/logis/b2b/assort/b2b-rtn-assort-job.html'
            }, {
              route: 'b2b_rtn_inspection',
              src: './scripts/fragments/logis/b2b/inspection/b2b-rtn-inspection.html'
            }, {
              route: 'b2b_cell_box_mapping_status',
              src: './scripts/fragments/logis/b2b/input/b2b-cell-box-mapping-status.html'
            }, {
              route: 'pda_one_sku_order',
              src: './scripts/fragments/logis/b2c/pick/b2c-one-sku-order.html'
            }, {
              route: 'b2b_sku_input',
              src: './scripts/fragments/logis/b2b/input/b2b-sku-input.html'
            }, {
              route: 'b2c_box_input',
              src: './scripts/fragments/logis/b2c/input/b2c-box-input.html'
            }, {
              route: 'b2b_out_middle_assort',
              src: './scripts/fragments/logis/b2b/assort/b2b-out-middle-assort.html'
            }, {
              route: 'b2b_out_middle_assort_weight',
              src: './scripts/fragments/logis/b2b/assort/b2b-out-middle-assort-with-weight.html'
            }, {
              route: 'b2b_rtn_middle_assort',
              src: './scripts/fragments/logis/b2b/assort/b2b-rtn-middle-assort.html'
            }, {
              route: 'b2c_qty_inspection',
              src: './scripts/fragments/logis/b2c/inspection/b2c-qty-inspection.html'
            }, {
              route: 'b2b_qty_inspection',
              src: './scripts/fragments/logis/b2b/inspection/b2b-qty-inspection.html'
            }, {
              route: 'b2b_weight_inspection',
              src: './scripts/fragments/logis/b2b/inspection/b2b-weight-inspection.html'
            }, {
              route: 'b2c_pick_single_pack',
              src: './scripts/fragments/logis/b2c/pick/b2c-pick-single-pack.html'
            },{
              route: 'b2c_packing_check',
              src: './scripts/fragments/logis/b2c/pack/b2c-packing-check.html'
            },{
              route: 'b2c_packing_popup',
              src: './scripts/fragments/logis/b2c/pack/b2c-packing-popup.html'
            },{
              route: 'label_list',
              src: './scripts/fragments/logis/common/label-list.html'
            }, {
              route: 'mps_region_input_list',
              src: './scripts/fragments/mps/rack-input-list.html'
            }, {
              route: 'cell_box_mapping_status',
              src: './scripts/fragments/logis/common/cell-box-mapping-status.html'
            }, {
              route: 'box_list',
              src: './scripts/fragments/logis/common/box-list.html'
            }, {
              route: 'picking_status',
              src: './scripts/fragments/logis/common/picking-status.html'
            }, {
              route: 'picking_status_by_cell',
              src: './scripts/fragments/logis/common/picking-status-by-cell.html'
            }, {
              route: 'b2b_remains_fullbox',
              src: './scripts/fragments/logis/b2b/pack/b2b-remains-fullbox.html'
            }]
          }
        }
      }

      /**
       * @description lifecycle
       **************************
       */
      connectedCallback() {
        super.connectedCallback();

        // 공통 컴퍼넌트 로드
        this.loadViews(this.commonElements);

        // 페이지 변경 이벤트 리스너 등록
        document.addEventListener('page-changed', event => {
          let targetElement = [];
          let targetIndex;

          this.viewElements.forEach((element, index) => {
            // viewElements 중 현재 라우팅의 src를 찾아서 targetElement와 targetIndex를 초기화
            if(element.route === event.detail.currentPage) {
              targetIndex = index;
              targetElement.push(element);
            }
          });

          // 임포트 대상 엘리먼트가 있다면
          if(targetElement && targetElement.length > 0) {
            // 대상 엘리먼트를 임포트
            this.loadViews(targetElement);
            // viewElements리스트에서 임포트 엘리먼트를 제거
            this.viewElements.splice(targetIndex, 1);
          }
        });
      }

      /**
       * @description 전달받은 elements.src의 경로를 통해 element를 임포트
       **************************
       * @param {Array} elements
       */
      loadViews(elements) {
        elements.forEach(element => {
          /**
           * @description 개발 / 프로덕션 모드에 따라 컴퍼넌트 임포트 방식을 변경함
           * 1. 개발 모드일 경우
           *    1) 모든 컴퍼넌트를 로컬에서 찾아 임포트 함
           *
           * 2. 프로덕션 모드일 경우
           *    1) CONST.SRC_URL을 통해 컴퍼넌트를 임포트 함
           */
          if(!CONST.IS_DEV_MODE) {
            const srcUrl = JSON.parse(localStorage.getItem('setting.srcUrl'));
            element.src = element.src.replace('./', `${srcUrl}/`);
          }

          Polymer.importHref(element.src, null, error => {
            throw `Failed to view importing. Error: ${error}`;
          }, true);
        })
      }
    }

    customElements.define(LogisViewLoader.is, LogisViewLoader);
  </script>
</dom-module>
