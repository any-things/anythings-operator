<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<!--
  물류 > PDA > PDA 설정 화면
-->
<dom-module id="logis-setting-pda">
  <template>
    <style include="shared-styles any-setting-styles"></style>

    <!-- 메시지 브로커 IP 조회(서버 설정)를 위한 Ajax -->
    <sys-ajax 
      id="broker-addrs-ajax" 
      method="GET" 
      content-type="application/json"
      on-sys-ajax-response="_setBrokerAddress">
    </sys-ajax>

    <!-- 메시지 브로커 Port 조회(서버 설정)를 위한 Ajax -->
    <sys-ajax 
      id="broker-port-ajax" 
      method="GET" 
      content-type="application/json" 
      on-sys-ajax-response="_setBrokerPort">
    </sys-ajax>

    <!-- 메시지 브로커 사이트 코드 조회(서버 설정)를 위한 Ajax -->
    <sys-ajax 
      id="broker-site-ajax" 
      method="GET" 
      content-type="application/json" 
      on-sys-ajax-response="_setBrokerSite">
    </sys-ajax>

    <!-- 작업 유형 리스트 조회를 위한 Ajax -->
    <sys-ajax 
      id="job-types-ajax" 
      method="GET" 
      content-type="application/json" 
      on-sys-ajax-response="_renderJobTypeCombo">
    </sys-ajax>

    <!-- 업데이트 내역 조회 -->
    <sys-ajax 
      id="update-ajax" 
      method="GET" 
      last-response="{{updatedItems}}">
    </sys-ajax>

    <!-- 서버에 PDA 상태 업데이트를 위한 Ajax -->
    <sys-ajax 
      id="update-setting-ajax" 
      method="PUT" 
      content-type="application/json">
    </sys-ajax>

    <!-- 업데이트 -->
    <div id="update-operato" class="input-container">
      <label style="text-align: left">[[updateLabel]]</label>
    </div>

    <!-- 업데이트 관련 버튼 -->
    <div class="button-container">
      <button id="view-updated-item-btn" on-click="_viewUpdateContent">[[detailedContentBtnLabel]]</button>
      <button id="update-btn" on-click="_moveToScreen">[[updateBtnLabel]]</button>
    </div>

    <!-- 새로고침 버튼 -->
    <div class="button-container">
      <button id="refresh-btn" on-click="_moveToScreen" style="float: right;">[[refreshBtnLabel]]</button>
    </div>
  </template>

  <script>
    class LogisSettingPda extends LogisSettingMixin(Polymer.Element) {
      static get is() {
        return 'logis-setting-pda'
      }

      static get properties() {
        return {
          /**
           * @description 장비 유형 라벨
           ***************
           * @type {String}
           */
          deviceType: {
            type: String,
            value: 'PDA'
          },

          /**
           * @description 송장 번호 표시 시작점 라벨
           ***************
           * @type {String}
           */
          invoiceFieldSubstrLabel: {
            type: String,
            value: () => t('label.invoice_field_substr')
          },

          /**
           * @description 내역 보기 버튼 라벨
           *********************
           * @type {String}
           */
          detailedContentBtnLabel: {
            type: String,
            value: () => t('button.detailed_content')
          },

          /**
           * @description 업데이트 버튼 라벨
           *********************
           * @type {String}
           */
          updateBtnLabel: {
            type: String,
            value: () => t('button.update')
          },

          /**
           * @description 새로 고침 버튼 라벨
           *********************
           * @type {String}
           */
          refreshBtnLabel: {
            type: String,
            value: () => t('button.refresh')
          }
        }
      }

      /**
       * @description Life Cycle connectedCallback
       ******************
       */
      connectedCallback() {
        super.connectedCallback();
        this._setDefaultValues();
        //this._getJobTypeList();
      }

      /**
       * @description 설정 항목들의 기본값을 저장하기 위한 함수
       ******************
       */
      _setDefaultValues() {
        this._setWorkSideDefaultValue();
      }

      /**
       * @description 설정 저장을 수행함
       * 설정 저장 전 updateSetting을 통해 서버에 변경 사항을 저장함
       * update 요청이 정상적으로 호출 되면 로컬스토리지의 값을 업데이트함
       ******************
       */
      saveSetting() {
        return new Promise((resolve, reject) => {
          this.updateSetting().then(() => {
              resolve();
            })
            .catch(error => {
              reject(error);
            })
        });
      }

      /**
       * @description 설정 값 변경을 서버에 요청함
       ******************
       */
      updateSetting() {
        return new Promise((resolve, reject) => {
          let equipType = LOGIS_UTIL.getLocalStorage('setting.equipType');
          let equipCd = LOGIS_UTIL.getLocalStorage('setting.equipCd');
          let stationCd = LOGIS_UTIL.getLocalStorage('setting.stationCd');
          let errMsg = null;

          if (!equipType) {
            errMsg = t('text.equip_type_is_not_set');
          } else if (!equipCd) {
            errMsg = t('text.equip_code_is_not_set');
          } else if (!stationCd) {
            errMsg = t('text.station_code_is_not_set');
          }

          if (errMsg) {
            throw {
              detail: {
                code: t('error.SETTING_ERROR'),
                msg: errMsg
              }
            };
          }

          const updateSettingAjax = this._getUpdateSettingAjax();
          updateSettingAjax.curl = `/${this.deviceType.toLowerCase()}s/update/setting`
          updateSettingAjax.params = {
            equip_type: equipType,
            equip_cd: equipCd,
            station_cd: stationCd
          };

          updateSettingAjax.addEventListener('sys-ajax-response', () => {
            resolve();
          });

          updateSettingAjax.addEventListener('sys-ajax-error', error => {
            reject(error);
          });

          updateSettingAjax.generateRequest();
        })
      }

      /**
       * @description 설비 설정 리셋
       ******************
       */
      /*resetRackInfo() {
        // 랙 코드 값 저장
        if (this.$['job-type-combo'].value != 'QPS' || this.jobType != 'QPS') {
          var rackCd = JSON.parse(localStorage.getItem(this.equipmentCdLSKey))
          var rackNm = JSON.parse(localStorage.getItem(this.equipmentNmLSKey))

          if (rackCd && rackNm) {
            this._getEquipCombo().value = rackCd;
          }

          // 작업 스테이션 값 저장
          var stationCd = JSON.parse(localStorage.getItem(this.stationCodeLSKey));
          if (!stationCd) {
            return;
          }

          var stationCombo = this._getStationCombo();
          var options = stationCombo.options;

          var items = [];
          for (let i = 0; i < options.length; i++) {
            items.push(options[i].value);
          }

          if (items.indexOf(stationCd) < 0) {
            const option = new Option(stationCd);
            option.selected = true;
            this.stationCd = stationCd;
            stationCombo.appendChild(option);
          } else {
            stationCombo.value = stationCd;
          }
        }
      }*/

      /**
       * @description 랙 정보 숨기기
       ******************
       */
      /*_hideRack() {
        if (this._getJobTypeCombo().selectedOptions.length > 0) {
          this.jobType = this._getJobTypeCombo().selectedOptions[0].value;
        }

        if (this.$['job-type-combo'].value == 'QPS' || this.jobType == 'QPS') {
          this.$['zone'].style.display = 'none';
          this.$['rack'].style.display = 'none';
          this.$['work-side'].style.display = 'none';
          LOGIS_UTIL.setLocalStorage('setting.equipCd', 'NA');
          LOGIS_UTIL.setLocalStorage('setting.equipNm', 'NA');
          LOGIS_UTIL.setLocalStorage('setting.stationCd', 'NA');
          LOGIS_UTIL.setLocalStorage('setting.isQps', true);

        } else {
          this.$['zone'].style.display = 'flex';
          this.$['rack'].style.display = 'flex';
          this.$['work-side'].style.display = 'flex';
          LOGIS_UTIL.setLocalStorage('setting.isQps', false);
        }
      }*/
    }

    customElements.define(LogisSettingPda.is, LogisSettingPda);
  </script>
</dom-module>