<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<!--
  물류 > PDA > PDA 설정 화면
-->
<dom-module id="logis-setting-pda">
  <template>
    <style include="shared-styles any-setting-styles"></style>

    <!-- 메시지 브로커 IP 조회(서버 설정)를 위한 Ajax -->
    <sys-ajax
      id="broker-addrs-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_setBrokerAddress">
    </sys-ajax>

    <!-- 메시지 브로커 Port 조회(서버 설정)를 위한 Ajax -->
    <sys-ajax
      id="broker-port-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_setBrokerPort">
    </sys-ajax>

    <!-- 메시지 브로커 사이트 코드 조회(서버 설정)를 위한 Ajax -->
    <sys-ajax
      id="broker-site-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_setBrokerSite">
    </sys-ajax>

    <!-- 호기 리스트 조회를 위한 Ajax -->
    <sys-ajax
      id="rack-items-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_renderRegionCombo">
    </sys-ajax>

    <!-- 장비 존 리스트 조회를 위한 Ajax -->
    <sys-ajax
      id="zone-items-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_renderZoneCombo">
    </sys-ajax>

    <!-- 작업 유형 리스트 조회를 위한 Ajax -->
    <sys-ajax
      id="job-combo-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_renderJobCombo">
    </sys-ajax>

    <!-- MPS 서버에 PDA 상태 업데이트를 위한 Ajax -->
    <sys-ajax
      id="update-setting-ajax"
      method="PUT"
      content-type="application/json">
    </sys-ajax>

    <!-- 작업 유형 설정 -->
    <div id="center" class="input-container">
      <label>[[jobLabel]]</label>
      <select id="job-combo" on-change="_hiddenRegion"></select>
    </div>

    <!-- 호기 설정 -->
    <div id="region" class="input-container">
      <label>[[regionLabel]]</label>
      <select id="region-combo" on-change="_getZoneItems"></select>
    </div>

    <!-- 작업 존 설정 -->
    <div id="zone" class="input-container">
      <label>[[zoneLabel]]</label>
      <select id="zone-combo"></select>
    </div>

    <!-- 작업 위치 (앞/뒤/앞,뒤/전체 등) 설정 -->
    <div id="work-loc" class="radio-btn-container">
      <label>[[workLocLabel]]</label>

      <div class="buttons">
        <input value="F" name="work-location" type="radio" work-loc-name$="[[frontLabel]]">
        <label>[[frontLabel]]</label>

        <input value="R" name="work-location" type="radio" work-loc-name$="[[rearLabel]]">
        <label>[[rearLabel]]</label>

        <input value="ALL" name="work-location" type="radio" work-loc-name$="[[frontLabel]]/[[rearLabel]]" checked>
        <label>[[frontLabel]]/[[rearLabel]]</label>

        <input value="T" name="work-location" type="radio" work-loc-name$="[[allLabel]]">
        <label>[[allLabel]]</label>
      </div>
    </div>

    <!-- 연속 스캔 설정 -->
    <div id="allow-continuous-scan" class="radio-btn-container">
      <label>[[allowContinousScanLabel]]</label>

      <div class="buttons">
        <input value="true" name="continuous-scan-allowed" type="radio" allow-continous-scan-name$="[[yesLabel]]">
        <label>[[yesLabel]]</label>

        <input value="false" name="continuous-scan-allowed" type="radio" allow-continous-scan-name$="[[noLabel]]" checked>
        <label>[[noLabel]]</label>
      </div>
    </div>

    <!-- 송장 번호가 길어서 표현하기 힘든 경우 잘라서 표현하기 위한 설정 -->
    <div id="invoice-field-substr" class="input-container">
      <label>[[invoiceFieldSubstrLabel]]</label>
      <input type="number" id="invoice-field-substr-input" min="0" value="[[invoiceFieldSubstr]]">
    </div>
  </template>

  <script>
    class LogisSettingPda extends LoigsSettingMixin(Polymer.Element) {
      static get is() {
        return 'logis-setting-pda'
      }

      static get properties() {
        return {
          /**
           * @description 장비 유형 라벨
           ***************
           * @type {String}
           */
          deviceType: {
            type: String,
            value: 'PDA'
          },

          /**
           * @description 송장 번호 표시 시작점 라벨
           ***************
           * @type {String}
           */
          invoiceFieldSubstrLabel: {
            type: String,
            value: () => t('label.invoice_field_substr')
          },

          /**
           * @description 연속 스캔 허용 라벨
           ***************
           * @type {String}
           */
          allowContinousScanLabel: {
            type: String,
            value: () => t('label.allow_continous_scan')
          },

          /**
           * @description 예 라벨
           ***************
           * @type {String}
           */
          yesLabel: {
            type: String,
            value: () => t('label.yes')
          },

          /**
           * @description 아니오 라벨
           ***************
           * @type {String}
           */
          noLabel: {
            type: String,
            value: () => t('label.no')
          },

          /**
           * @description 라벨 재발행 화면 -> 송장 번호 필드에 표시할 문자 수 제한
           ***************
           * @type {String}
           */
          invoiceFieldSubstr: {
            type: String,
            value: () => JSON.parse(localStorage.getItem('setting.invoiceFieldSubstr'))
          },

          /**
           * @description 라벨 재발행 화면 -> 송장 번호 필드에 표시할 문자 수 제한 저장을 위한 localStorage의 key
           ***************
           * @type {String}
           */
          invoiceFieldSubstrLSKey: {
            type: String,
            value: 'setting.invoiceFieldSubstr'
          },

          /**
           * @description 연속 스캔 허용
           ***************
           * @type {String}
           */
          continousScanAllowed: {
            type: String,
            value: () => JSON.parse(localStorage.getItem('setting.continousScanAllowed'))
          },

          /**
           * @description 연속 스캔 허용값 저장을 위한 localStorage의 key
           ***************
           * @type {String}
           */
          continousScanAllowedLSKey: {
            type: String,
            value: 'setting.continousScanAllowed'
          }
        }
      }

      /**
       * @description Life Cycle connectedCallback
       ******************
       */
      connectedCallback() {
        super.connectedCallback();
        this._getRegionItems();
        this._setDefaultValues();
        this._getJobItems();
        this._hiddenRegion();
      }

      /**
       * @description 설정 항목들의 기본값을 저장하기 위한 함수
       ******************
       */
      _setDefaultValues() {
        this._setWorkLocDefaultValue();
        this._setContinousScanDefaultValue();
      }

      /**
       * @description 설정 저장을 수행함
       * 설정 저장 전 updateSetting을 통해 서버에 변경 사항을 저장함
       * update 요청이 정상적으로 호출 되면 로컬스토리지의 값을 업데이트함
       ******************
       */
      saveSetting() {
        return new Promise((resolve, reject) => {
          this.updateSetting().then(() => {
              // 호기 코드 값 저장
              this._setLocalStorage(this.regionCodeLSKey, this._getRegionCombo().selectedOptions[0].value);
              // 호기 명 값 저장
              this._setLocalStorage(this.regionNameLSKey, this._getRegionCombo().selectedOptions[0].innerText);
              // 작업 존 값 저장
              this._setLocalStorage(this.zoneCodeLSKey, this._getZoneCombo().selectedOptions[0].value);
              // 작업 유형 값 저장
              this._setLocalStorage(this.jobNameLSKey, this._getJobCombo().selectedOptions[0].value);
              // 작업 위치 값 저장
              this._setLocalStorage(this.workLocLSKey, this._getSelectedOpt(this._getWorkLocationOpts()).value);
              // 작업 위치 라벨 저장
              this._setLocalStorage(this.workLocNameLSKey, this._getSelectedOpt(this._getWorkLocationOpts()).getAttribute('work-loc-name'));
              // 송장 번호 표시를 위한 필드 문자 제한 수
              const invoiceFieldSubstr = parseInt(this._getInvoiceFieldSubstrInput().value);
              this._setLocalStorage(this.invoiceFieldSubstrLSKey, invoiceFieldSubstr > 0 ? invoiceFieldSubstr : 0);
              // 연속 스캔 허용 값 저장
              const contiScanAllowed = this._getSelectedOpt(this._getContinousScanAllowedOpts()).value;
              this._setLocalStorage(this.continousScanAllowedLSKey, contiScanAllowed == 'true');
              resolve();
            })
            .catch(error => {
              reject(error);
            })
        });
      }

      /**
       * @description 설정 값 변경을 서버에 요청함
       ******************
       */
      updateSetting() {
        return new Promise((resolve, reject) => {
          const regionCombo = this._getRegionCombo();
          const regionCode = regionCombo.selectedOptions.length === 1 ? regionCombo.selectedOptions[0].value : null;
          const zoneCombo = this._getZoneCombo()
          const zoneCode = zoneCombo.selectedOptions.length === 1 ? zoneCombo.selectedOptions[0].value : null;

          if (!regionCode || !zoneCode) {
            throw {
              detail: {
                code: t('error.SETTING_ERROR'),
                msg: !regionCode ? t('text.region_code_is_not_set') : t('text.zone_code_is_not_set')
              }
            };
          }

          const updateSettingAjax = this._getUpdateSettingAjax();
          updateSettingAjax.curl = `/${this.deviceType.toLowerCase()}s/update/setting`
          updateSettingAjax.params = {
            equip_type: 'Rack',
            equip_cd: regionCode,
            station_cd: zoneCode
          };

          updateSettingAjax.addEventListener('sys-ajax-response', () => {
            resolve();
          });

          updateSettingAjax.addEventListener('sys-ajax-error', error => {
            reject(error);
          });

          updateSettingAjax.generateRequest();
        })
      }

      /**
       * @description return 송장 번호 필드 문자 제한 수 인풋
       ******************
       */
      _getInvoiceFieldSubstrInput() {
        return this.$['invoice-field-substr-input'];
      }

      /**
       * @description 연속 스캔 허용 값 리턴
       ******************
       */
      _getContinousScanAllowedOpts() {
        return Array.from(this.$['allow-continuous-scan'].querySelectorAll('input[name=continuous-scan-allowed]'));
      }

      /**
       * @description 연속 스캔 허용 값 설정
       ******************
       */
      _setContinousScanDefaultValue() {
        const continousScanOpts = this._getContinousScanAllowedOpts();

        if (this.continousScanAllowed) {
          continousScanOpts.forEach(continousScanOpt => {
            if (this.continousScanAllowed.toString() === continousScanOpt.value) {
              continousScanOpt.checked = true;
            }
          });
        }
      }

      resetRegionInfo() {
        // 호기 코드 값 저장
        if (this.$['job-combo'].value != 'QPS' || this.jobName != 'QPS') {
          var regionCd = JSON.parse(localStorage.getItem(this.regionCodeLSKey))
          var regionNm = JSON.parse(localStorage.getItem(this.regionNameLSKey))

          if (regionCd && regionNm) {
            this._getRegionCombo().value = regionCd;
          }

          // 작업 존 값 저장
          var zoneCd = JSON.parse(localStorage.getItem(this.zoneCodeLSKey));
          if (!zoneCd) {
            return;
          }

          var zoneCombo = this._getZoneCombo();
          var options = zoneCombo.options;

          var items = [];
          for (let i = 0; i < options.length; i++) {
            items.push(options[i].value);
          }

          if (items.indexOf(zoneCd) < 0) {
            const option = new Option(zoneCd);
            option.selected = true;
            this.zoneCd = zoneCd;
            zoneCombo.appendChild(option);
          } else {
            zoneCombo.value = zoneCd;
          }
        }

      }

      /**
       * @description 호기 정보 숨기기
       ******************
       */
      _hiddenRegion() {
        if (this._getJobCombo().selectedOptions.length > 0) {
          this.jobName = this._getJobCombo().selectedOptions[0].value;
        }

        if (this.$['job-combo'].value == 'QPS' || this.jobName == 'QPS') {
          this.$['zone'].style.display = 'none';
          this.$['region'].style.display = 'none';
          this.$['work-loc'].style.display = 'none';
          this.$['invoice-field-substr'].style.display = 'none';
          this._setLocalStorage('setting.regionCode', 'NA');
          this._setLocalStorage('setting.regionName', 'NA');
          this._setLocalStorage('setting.zoneCode', 'NA');
          this._setLocalStorage('setting.isQps', true);

        } else {
          this.$['zone'].style.display = 'flex';
          this.$['region'].style.display = 'flex';
          this.$['work-loc'].style.display = 'flex';
          this.$['invoice-field-substr'].style.display = 'flex';
          this._setLocalStorage('setting.isQps', false);
        }
      }
    }

    customElements.define(LogisSettingPda.is, LogisSettingPda);
  </script>
</dom-module>
