<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="./label-details.html">

<!--
  물류 > 공통 > 라벨 발행 리스트
-->
<dom-module id="label-list">
  <template>
    <style include="shared-styles">
      :host {
        display: grid;
        grid-template-rows: 1fr;
        padding: 10px;
        height: calc(100% - 20px);
      }
      #button-container {
        display: grid;
        grid-template-columns: auto auto;
        justify-content: end;
        margin-top: 10px;
      }
    </style>

    <!-- 박싱 리스트 -->
    <sys-ajax
      auto
      id="box-list-ajax"
      method="GET"
      content-type="application/json"
      last-response="{{boxList}}">
    </sys-ajax>

    <!-- 박스 리스트 -->
    <item-list
      id="box-list"
      header="[[header]]"
      data="[[boxList]]"
      on-data-list-click="_showReprintPopup">
    </item-list>

    <!-- 버튼 리스트 -->
    <div id="button-container">
      <button is-pda$="[[isPda]]"on-click="searchBoxList">[[refreshBtnLabel]]</button>
    </div>
  </template>

  <script>
    class LabelList extends Polymer.Element {
      static get is() {
        return 'label-list'
      }

      static get properties() {
        return {
          /**
           * @description PDA인지 여부
           ****************
           * @type {Boolean}
           */
          isPda: {
            type: Boolean
          },

          /**
           * @description 새로고침 라벨
           ****************
           * @type {Array}
           */
          refreshBtnLabel: {
            type: String,
            value: () => t('button.refresh')
          },

          /**
           * @description 그리드 헤더
           ****************
           * @type {Array}
           */
          header: {
            type: Array,
            value: function() {
              return [{
                display: t('label.customer'),
                fieldname: 'cust_nm',
                columnWidth: '0.5fr',
                displayCallback: (value, rowData) => {
                  return `(${rowData.box_seq}) ${value}`;
                }
              }, {
                display: t('label.cell'),
                fieldname: 'loc_cd',
                columnWidth: '0.175fr',
                style: {
                  textAlign: 'center'
                },
                displayCallback: (value, rowData) => {
                  return `${value.split('-')[1]}`;
                }
              }, {
                display: t('label.label_cd'),
                fieldname: 'invoice_id',
                columnWidth: '0.325fr',
                style: {
                  textAlign: 'center'
                },
                displayCallback: (value, rowData) => {
                  var val = value ? value : rowData.box_id;
                  var idx = LOGIS_UTIL.getInvoiceNoStartIndex();
                  return (val && idx && idx > 0) ? val.substring(idx) : val;
                }
              }, {
                fieldname: 'id',
                hidden: true
              }, {
                fieldname: 'box_seq',
                hidden: true
              }, {
                fieldname: 'box_id',
                hidden: true
              }]
            }
          },

          /**
           * @description 그리드 데이터
           ****************
           * @type {Array}
           */
          boxList: {
            type: Array,
            value: function() {
              return [];
            }
          }
        }
      }

      /**
       * @description connectedCallback
       ****************************
       */
      connectedCallback() {
        super.connectedCallback();

        // 해더의 refresh button 클릭시 발생하는 refres-view-[route] event handler
        document.addEventListener('refresh-view-' + location.hash.replace('#/', ''), event => {
          this.searchBoxList();
        });

        this.searchBoxList();
      }

      /**
       * @description 송장 번호가 발행된 박스 리스트 조회
       ***************************
       */
      searchBoxList() {
        var ajax = this.$['box-list-ajax'];
        ajax.curl = '/tablet_process/boxed_list/' + LOGIS_UTIL.getEquipCd() + '/' + LOGIS_UTIL.getStationCd() + '/' + LOGIS_UTIL.getWorkSideCd();

        // 최초 조회 이후 baseUrl이 초기화 되었다면 명시적으로 generateRequest를 호출함
        if (ajax.baseUrl) {
          ajax.generateRequest();
        }
      }

      /**
       * @description 리스트에서 선택한 로우를 활성화 함
       ****************************
       * @param {Object} event
       */
      _showReprintPopup(event) {
        const reprintPopup = document.createElement('label-details');
        reprintPopup.boxResultId = event.detail.data.id;
        reprintPopup.custName = event.detail.data.cust_nm;
        reprintPopup.invoiceId = event.detail.data.invoice_id ? event.detail.data.invoice_id : event.detail.data.box_id;
        reprintPopup.locCd = event.detail.data.loc_cd;

        LOGIS_UTIL.showPopup(t('button.print_label'), reprintPopup, 'fit', 'fit', null, function() {
          this.searchBoxList();
        }.bind(this));

        /*document.dispatchEvent(new CustomEvent('open-dialog', {
          detail: {
            title: t('button.print_label'),
            content: reprintPopup,
            width: 'fit',
            height: 'fit',
            closeCallback: () => {
              this.searchBoxList();
            }
          }
        }))*/
      }
    }

    customElements.define(LabelList.is, LabelList);
  </script>
</dom-module>