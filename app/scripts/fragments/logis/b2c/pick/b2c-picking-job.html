<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../../../styles/tab-order-info-styles.html">

<link rel="import" href="../../../../mixins/common/ble-scanner-mixin.html">
<link rel="import" href="../../../../mixins/logis/logis-common-assort-mixin.html">
<link rel="import" href="../../../../mixins/logis/logis-msg-subscribe-mixin.html">

<link rel="import" href="../../../../components/common/bluetooth-scanner-selector.html">
<link rel="import" href="../../../../components/logis/adjust-qty-popup.html">
<link rel="import" href="../../../../components/logis/job-transaction-popup.html">

<!--
  물류 > B2C > 소분류 처리 화면 (Tablet)
-->
<dom-module id="b2c-picking-job">
  <template>
    <style include="tab-order-info-styles">
      #prod-info #prod-info-right {
        display: flex;
        flex-direction: column;
        flex: 1;
        margin-right: .5rem;
      }

      #prod-info-right input {
        max-width: 4rem;
        font-size: .8rem;
        color: white;
        background-color: #5A6377;
      }

      #prod-info #prod-info-left {
        display: flex;
        flex-direction: column;
      }

      .prod-list {
        display: grid;
        grid-template-columns: max-content auto max-content max-content;
      }

      .totalaccount {
        display: inline-block;
        padding: 0 10px 0 5px;
        color: rgba(255, 255, 255, .7)
      }

      #icon-section {
        display: flex;
        flex: 1;
      }

      button#done-btn {
        margin-left: .5rem;
        width: 200px;
      }

      img#qr-done {
        float: inherit;
        margin: auto;
        height: 3rem;
      }

      #ble-section {
        display: flex;
        flex-direction: column;
      }

      auto-popup-input {
        display: none;
      }
    </style>

    <!-- MPI 리스트 -->
    <sys-ajax id="mpi-get-ajax" method="GET" content-type="application/json" on-sys-ajax-response="_mpiCodeSetting">
    </sys-ajax>

    <!-- 상품 정보 스캔 투입 리스트 -->
    <sys-ajax auto id="input-list-ajax" method="GET" content-type="application/json"
      on-sys-ajax-response="_inputListResponsed">
    </sys-ajax>

    <!-- 상품 정보 스캔 투입 리스트 페이지네이션 -->
    <sys-ajax id="input-list-pages-ajax" method="GET" content-type="application/json"
      on-sys-ajax-response="_inputListPageResponsed">
    </sys-ajax>

    <!-- 투입 이벤트의 거래처 작업 리스트 -->
    <sys-ajax id="input-job-details-ajax" method="PUT"
      curl="/tablet_process/dps/input_details/:job_input_seq_id/:region_cd/:zone_cd/:side_cd"
      content-type="application/json" last-response="{{inputDetails}}">
    </sys-ajax>

    <!-- 태블릿 작업 존의 처리 안된 혹은 처리 완료된 작업을 조회하여 표시기에 점등 -->
    <sys-ajax id="mpi-on-jobs-ajax" method="PUT"
      curl="/tablet_process/dps/mpi_on/:job_input_seq_id/:region_cd/:zone_cd/:side_cd/:done_or_todo"
      content-type="application/json">
    </sys-ajax>

    <!-- 태블릿 작업 존의 모든 표시기를 소등 -->
    <sys-ajax id="mpi-off-my-zone-ajax" method="PUT" curl="/tablet_process/mpi_off/:region_cd/:zone_cd/:side_cd"
      content-type="application/json">
    </sys-ajax>

    <!-- DPS 웨어러블 검수 기능 & QPS 웨어러블 검수 / 박스 수동 투입 -->
    <sys-ajax id="insp-with-pick-ajax" method="PUT"
      curl="/tablet_process/dps/insp_with_pick/:region_cd/:zone_cd/:sideCd/:input_seq/:skuCd"
      content-type="application/json" on-sys-ajax-response="_inspWithPickResponsed"
      on-sys-ajax-error="_inspWithPickError">
    </sys-ajax>

    <!-- DPS출발   -->
    <sys-ajax id="depart-ajax" method="PUT" curl="/tablet_process/dps/box_depart/:region_cd/:zone_cd/:box_id"
      content-type="application/json">
    </sys-ajax>

    <div id="status">
      <div id="chart">[[pickedPercent]]<span>%</span></div>

      <img id="back-to-current-btn" src="./images/iconbtn-das-order3.png" on-click="refreshInputList" />
      <img id="mpi-on-todo-btn" src="./images/iconbtn-das-order1.png" on-click="mpiOnTodoJobs" />
      <img id="mpi-on-done-btn" src="./images/iconbtn-das-order2.png" on-click="mpiOnDoneJobs" hidden$="[[isQps]]" />
      <div id="picked-qty">
        [[pickedQtyLabel]]
        <span>[[pickedQty]]</span>
      </div>

      <div id="total-pick-qty">
        [[totalOrdQtyLabel]]
        <span>[[totalPickQty]]</span>
      </div>
    </div>

    <div id="prod-info">
      <div id="prod-info-left">
        <span>[[orderIdLabel]]</span>
        <span class="prodname">[[orderId]]</span>
      </div>
      <!-- SKU 정보 조회 시 복수개가 조회된 경우 실행되는 사용자가 고를 수 있는 팝업이 가미된 SKU Input -->
      <auto-popup-input id="sku-barcd" resource-url="[[getSkuAjaxUrl]]" popup-title="[[popupTitleLabel]]"
        button-txt-callback="[[_skuButtonTxtCallback]]" on-item-selected="skuSelected">
      </auto-popup-input>
      <!-- 개발 모드일때만 인풋 박스 표시 -->
      <dom-if if="[[isDevMode]]">
        <template>
          <div id="prod-info-right">
            <label>[[bucketCdLabel]]</label>
            <input id="bucket-code" placeholder="개발 모드" class="row" on-keypress="_onBucketCodeChanged">
          </div>
        </template>
      </dom-if>

      <div id="icon-section">
        <div id="ble-section">
          <label id="ble-id">[[deviceName]]</label>
          <iron-icon id="bluetooth-btn" icon="[[bluetoothIcon]]" on-click="bluetoothIconClicked"></iron-icon>
        </div>
        <img id="qr-done" src="./static/assets/tab_codes/done_by_qr.png" />
        <button id="done-btn" on-click="doneIconClicked">
          <!-- <iron-icon id="done-btn" icon="[[doneIcon]]" on-click="doneIconClicked"></iron-icon> -->
          [[finishLabel]]
        </button>
      </div>
    </div>

    <div id="content">
      <dom-if if="[[showFront]]">
        <template>
          <div id="left-section">
            <button class="list-header-btn" disabled>[[frontBtnLabel]]</button>

            <item-list id="front-list" hide-header header="[[header]]" data="[[frontDetailList]]"
              on-data-list-click="showProcessPopup" on-configured="_addOrderStatusAttr">
            </item-list>
          </div>
        </template>
      </dom-if>

      <job-progress-bar id="dps-job-indicator" job-type="[[jobType]]" selected-input="{{selectedInput}}"
        on-item-selected="_selectedInputChanged" on-item-selected-by-click="_selectedInputChanged"
        input-list="[[inputList]]" on-configured="_addJobStatusAttr">
      </job-progress-bar>

      <dom-if if="[[showRear]]">
        <template>
          <div id="right-section">
            <button class="list-header-btn" disabled>[[rearBtnLabel]]</button>

            <item-list id="rear-list" hide-header header="[[header]]" data="[[rearDetailList]]"
              on-data-list-click="showProcessPopup" on-configured="_addOrderStatusAttr">
            </item-list>
          </div>
        </template>
      </dom-if>

      <dom-if if="[[showTotal]]">
        <template>
          <div id="total-section">
            <button class="list-header-btn" disabled>[[totalBtnLabel]]</button>

            <item-list id="total-list" hide-header header="[[header]]" data="[[totalDetailList]]"
              on-data-list-click="showProcessPopup" on-configured="_addOrderStatusAttr">
            </item-list>
          </div>
        </template>
      </dom-if>
    </div>

    <!-- <job-progress-bar id="dps-job-indicator" job-type="[[jobType]]" selected-input="{{selectedInput}}"
      on-item-selected="_selectedInputChanged" on-item-selected-by-click="_selectedInputChanged"
      input-list="[[inputList]]" on-configured="_addJobStatusAttr">
    </job-progress-bar> -->
  </template>

  <script>
    class B2cPickingJob extends LogisMsgSubscribeMixin(LosigCommonAssortMixin(BleScannerMixin(Polymer.Element))) {
      static get is() {
        return 'b2c-picking-job'
      }

      static get properties() {
        return {
          /**
           * 주문 번호 라벨
           ****************
           * @type {String}
           */
          orderIdLabel: {
            type: String,
            value: () => t('label.order_id')
          },

          /**
           * 완료 버튼 라벨
           ****************
           * @type {String}
           */
          finishLabel: {
            type: String,
            value: () => t('label.finished')
          },

          /**
           * 개발 모드 여부
           ****************
           * @type {Boolean}
           */
          isDevMode: {
            type: Boolean,
            value: window.CONST.IS_DEV_MODE
          },

          /**
           * 개발 모드에서 사용하는 버킷 코드의 라벨
           ****************
           * @type {String}
           */
          bucketCdLabel: {
            type: String,
            value: () => t('label.bucket')
          },

          /**
           * 왼쪽 로케이션 라벨
           ****************
           * @type {String}
           */
          locLeftLabel: {
            type: String,
            value: () => t('label.left')
          },

          /**
           * 오른쪽 로케이션 라벨
           ****************
           * @type {String}
           */
          locRightLabel: {
            type: String,
            value: () => t('label.right')
          },

          /**
           * 표시기 코드
           ****************
           * @type {String}
           */
          mpiCd: {
            type: String,
            value: 'NaN'
          },

          /**
           * 데이트 그리드 헤더
           ****************
           * @type {Array}
           */
          header: {
            type: Array,
            value: function () {
              return [{
                fieldname: 'loc_cd',
                columnWidth: 'auto',
                displayCallback: value => '(' + (value ? value.substring(4) : '') + ')'
              }, {
                fieldname: 'div_cd',
                columnWidth: 'auto',
                hidden: true
              }, {
              }, {
                fieldname: 'sku_nm',
              }, {
                fieldname: 'picking_sum',
                style: {
                  textAlign: 'right'
                },
                columnWidth: 'auto',
                displayCallback: (value, rowData) => {
                  var processValue = 0;
                  if (rowData.picking_qty > 0) {
                    processValue = rowData.picking_qty
                  } else {
                    processValue = rowData.picked_qty
                  }

                  return `${processValue}/${rowData.pick_qty}`;
                },
                style: {
                  width: 'max-content'
                }
              }, {
                fieldname: 'picking_qty',
                hidden: true
              }, {
                fieldname: 'pick_qty',
                hidden: true
              }, {
                fieldname: 'picked_qty',
                hidden: true
              }, {
                fieldname: 'id',
                hidden: true
              }, {
                fieldname: 'status',
                hidden: true
              }, {
                fieldname: 'sku_cd',
                hidden: true
              }, {
                fieldname: 'sku_barcd',
                hidden: true
              }, {
                fieldname: 'mpi_cd',
                hidden: true
              }]
            }
          },

          /**
            * 화면에서 완료 버튼 아이콘
            ****************
            * @type {String}
            */
          doneIcon: {
            type: String,
            value: 'icons:done'
          },

          /**
           * 스캔한 바코드 저장용
           ****************
           * @type {String}
           */
          scannedBarcode: {
            type: String
          },

          /**
           * 스캔한 바코드 처리후 유형이 input-added이면 scannedBarcode를 boxId에 저장
           ****************
           * @type {String}
           */
          boxId: {
            type: String
          },

          /**
           * 작업 유형
           ****************
           * @type {String}
           */
          jobType: {
            type: String,
            value: 'DPS'
          },

          /**
           * SKU 정보 조회를 위한 URL
           ****************
           * @type {String}
           */
          getSkuAjaxUrl: {
            type: String,
            value: `/pda_process/find_sku/${LOGIS_UTIL.getRegionCd()}/:inputValue`
          },

          /**
           * SKU 정보 조회 후 복수개가 조회된 경우 사용자가 고를 수 있는 팝업이 실행되는데 그 팝업에 표시할 타이틀
           ****************
           * @type {String}
           */
          popupTitleLabel: {
            type: String,
            value: () => t('label.sku')
          },

          /**
           * 블루투스 ID
           ****************
           * @type {String}
           */
          bluetoothId: {
            type: String
          },

          /**
           * QPS 여부
           ****************
           * @type {Boolean}
           */
          isQps: {
            value: JSON.parse(localStorage.getItem('setting.isQps'))
          },

          /**
           * ?
           ****************
           * @type {Array}
           */
          needMpiScanCode: {
            type: Array,
            value: []
          }
        }
      }

      /**
       * @description lifecycle
       ******************
       */
      connectedCallback() {
        super.connectedCallback();
        this._getMpiCd();
      }

      /**
       * @description 표시기 리스트 조회
       ******************
       */
      _getMpiCd() {
        const mpiGetAjax = this.$['mpi-get-ajax'];
        mpiGetAjax.baseUrl = JSON.parse(localStorage.getItem('setting.baseUrl'));
        mpiGetAjax.customParams = {
          select: "mpi_cd",
          sort: [{
            "field": "loc_cd",
            "ascending": true
          }],
          page: 1,
          limit: 10000
        };

        mpiGetAjax.curl = `/location`;
        mpiGetAjax.generateRequest();
      }

      /**
       * @description 표시기 리스트 설정
       ******************
       * @param {Object} event
       */
      _mpiCodeSetting(event) {
        this.mpiList = [];

        event.detail.items.forEach(item => {
          this.mpiList.push(item.mpi_cd);
        });
      }

      /**
       * @description 상품 투입 상세 정보로 현황 정보 리프레쉬
       ******************
       * @param {Array} inputDetails
       */
      _updateStatus(inputDetails) {
        // input detail의 내용이 없을 경우 다음 아이템을 선택함 == 나와 관계 없는 작업들 처리...
        if (inputDetails.length === 0 && !this.holdIndicator && LOGIS_UTIL.getAutoPicking()) {
          if (!this.$['dps-job-indicator'].selectNextItem()) {
            this.refreshInputList();
          }
        }
        let totalPickQty = 0; // 총 주문 수량
        let pickedQty = 0;    // 총 확정 수량
        let canceledQty = 0;   // 작업 취소된 상품 수량

        inputDetails.forEach(item => {
          totalPickQty += item.pick_qty;
          pickedQty += item.picked_qty;
          item.left_qty = item.pick_qty - item.picked_qty;
          if (item.status === 'C') canceledQty += item.pick_qty;
        });

        // pickedCanceldPercent를 완료 + 취소된 작업의 전체 작업 대비 퍼센트를 계산하여
        // 다음 블럭을 선택하는 기준 percent로 삼는다.
        // inputDetails 중에 완료되지 않았지만 취소상태인 작업이 있다면 해당 작업도 이후에 처리할 것이기 때문에
        // 다음 블럭을 선택하거나 inputList를 다시 조회해야함
        const pickedCanceldPercent = (totalPickQty && totalPickQty > 0 && pickedQty && pickedQty > 0) ?
          Math.floor((pickedQty + canceledQty) / totalPickQty * 100) : 0;

        this.totalPickQty = totalPickQty;
        this.pickedQty = pickedQty;
        this.pickedPercent =
          (totalPickQty && totalPickQty > 0 && pickedQty && pickedQty > 0) ?
            Math.floor(pickedQty / totalPickQty * 100) : 0;

        this._updateBlockChart(this.pickedPercent);

        // 작업률 100% & 자동피킹이 true로 설정 && 사용자에 의해 클릭을 통해 변경되지 않은 경우 => true
        if (pickedCanceldPercent === 100 && LOGIS_UTIL.getAutoPicking() && !this.holdIndicator) {
          // 다음 아이템이 없을 경우 false를 리턴함
          if (!this.$['dps-job-indicator'].selectNextItem()) {
            // 마지막 아이템일 경우 input list를 다시 조회
            this.refreshInputList();
          }
        } else if (this.holdIndicator) {
          // holdIndicator flag에 의해 selectNextItem을 호출 하지 않은 경우 holdIndicator의 값을 변경
          this.holdIndicator = false;
        }
      }

      /**
       * @description 이미 처리한 작업에 대해서 확인을 위해서 다시 한 번 표시기에 점등
       * toggle 버튼이기 때문에 active attribute를 추가/제거 함
       *********************
       * @param {Object} event
       */
      mpiOnDoneJobs(event) {
        const mpiOnDoneJobsBtn = event.currentTarget;
        const isButtonActive = mpiOnDoneJobsBtn.getAttribute('active');

        // 태블릿의 작업 존의 모든 표시기 소등
        if (isButtonActive === '') {
          mpiOnDoneJobsBtn.removeAttribute('active');
          this.mpiOffByTabletZone();

          // 태블릿의 작업 존에 현재 선택된 버킷 (즉 주문) 중에 처리 완료된 작업 리스트에 대한 표시기 점등
        } else {
          mpiOnDoneJobsBtn.setAttribute('active', '');
          this.mpiOnByTabletZone('done');
        }
      }

      /**
       * @description 선택된 버킷 즉 주문의 상품 중에서 아직 처리가 안 된 상품 및 개수를 표시기로 표시
       * toggle 버튼이기 때문에 active attribute를 추가/제거 함
       *********************
       * @param {Object} event
       */
      mpiOnTodoJobs(event) {
        const mpiOnTodoJobsBtn = event.currentTarget;
        const isButtonActive = mpiOnTodoJobsBtn.getAttribute('active');

        // 태블릿의 작업 존의 모든 표시기 소등
        if (isButtonActive === '') {
          mpiOnTodoJobsBtn.removeAttribute('active');
          this.mpiOffByTabletZone();

          // 태블릿의 작업 존에 현재 선택된 버킷 (즉 주문) 중에 처리 안 된 작업 리스트에 대한 표시기 점등
        } else {
          mpiOnTodoJobsBtn.setAttribute('active', '');
          this.mpiOnByTabletZone('todo');
        }
      }

      /**
       * @description 태블릿 작업 존에 해당하는 표시기 리스트를 소등한다.
       ******************
       */
      mpiOffByTabletZone() {
        const mpiOffAjax = this.$['mpi-off-my-zone-ajax'];
        let regionCd = LOGIS_UTIL.getRegionCd();
        let zoneCd = LOGIS_UTIL.getZoneCd();
        let sideCd = LOGIS_UTIL.getSideCd();
        mpiOffAjax.curl = `/tablet_process/mpi_off/${regionCd}/${zoneCd}/${sideCd}`;
        mpiOffAjax.generateRequest();
      }

      /**
       * @description mode에 따라 태블릿의 작업 존에 현재 선택된 버킷 (즉 주문) 중에 처리 안 된 혹은 처리 완료된 작업 리스트에 대한 표시기 점등
       ******************
       * @param {String} mode
       */
      mpiOnByTabletZone(mode) {
        const mpiOnAjax = this.$['mpi-on-jobs-ajax'];
        let inputSeqId = this.selectedInput.id;
        let regionCd = LOGIS_UTIL.getRegionCd();
        let zoneCd = LOGIS_UTIL.getZoneCd();
        let sideCd = LOGIS_UTIL.getSideCd();
        mpiOnAjax.curl = `/tablet_process/dps/mpi_on/${inputSeqId}/${regionCd}/${zoneCd}/${sideCd}/${mode}`;
        mpiOnAjax.generateRequest();
      }

      /**
       * @description 작업 팝업 정보 표시
       ******************
       * @param {Object} event
       */
      showProcessPopup(event) {
        // status가 'F'면 완료된 작업
        let status = event.detail.data.status;
        this.selectedBarCode = event.detail.data.sku_barcd;
        var pickQty = event.detail.data.pick_qty;

        if (status === 'I' || status === 'P') {
          const popup = document.createElement('job-transaction-popup');
          popup.skuCd = event.detail.data.sku_barcd
          popup.jobType = this.jobType;
          popup.jobId = event.detail.data.id;
          popup.pickQty = pickQty;
          popup.pickedQty = event.detail.data.picked_qty;
          popup.isFinished = (status === 'F');
          var self = this;

          LOGIS_UTIL.showPopup(t('title.job_select'), popup, 'fit', 'fit', null, closeParam => {
            if (closeParam && typeof closeParam === 'object' && closeParam.type === 'adjust-qty') {
              const adjustPopup = document.createElement('adjust-qty-popup');

              setTimeout(() => {
                LOGIS_UTIL.showPopup(t('button.adjust_qty'), adjustPopup, 'fit', 'fit', () => {
                  adjustPopup.setCurrentQty(closeParam.pickQty);
                  adjustPopup.jobId = closeParam.jobId;
                }, () => {
                  self.refreshInputDetails(false);
                });
              }, 100);

            } else {
              self.refreshInputDetails(false);
            }
          });
        }
      }

      /**
       * @description 웹 소켓으로 부터 데이터 리프레쉬
       ******************
       * @param {Object} data
       */
      refreshByWs(data) {
        if (data == 'input-added' || data == 'wait-added') {
          // 투입 정보 리스트가 없는 경우 투입 정보 리스트 조회
          if (!this.inputList || this.inputList.length < 4) {
            this.refreshInputList();
          }
        } else if (data == 'arrive-added') {
          // 투입 정보 리스트가 없는 경우 투입 정보 리스트 조회
          this.refreshInputList();
          this.refreshInputDetails(false);

        } else {
          //this.refreshInputList();
          this.refreshInputDetails(false);
        }
      }

      /**
       * @description list configured event handler
       * list 구성이 완료 되면 status 데이터를 바탕으로 status attribute를 추가함
       ******************
       * @param {Object} event
       */
      _addOrderStatusAttr(event) {
        let list = event.detail.contentElements;
        var selectedBCd = this.selectedBarCode;

        list.forEach(row => {
          let data = row.getData();

          if (data.div_cd == 'L') {
            row.getElementsByClassName("data-item")[0].innerText = '(' + this.locLeftLabel + ')';
            row.getElementsByClassName("data-item")[2].innerText = '';

          } else if (data.div_cd == 'R') {
            row.getElementsByClassName("data-item")[0].innerText = '(' + this.locRightLabel + ')';
            row.getElementsByClassName("data-item")[2].innerText = '';
          }

          if (parseInt(data.picked_qty) >= parseInt(data.pick_qty)) {
            row.classList.add('complete'); // 완료된 데이터에 complete class를 추가
            var dataList = [];
            dataList = dataList.concat(this.inputDetails.F, this.inputDetails.R);

            dataList.forEach(item => {
              if (item.mpi_cd == this.mpiCd && item.picked_qty >= item.pick_qty) {
                this.mpiCd = 'NaN';
                this.needMpiScanCode = [];
              }
            })
            if (selectedBCd == data.sku_barcd) {
              document.dispatchEvent(new CustomEvent('close-dialog'));
            }
          } else {
            if (data.div_cd == 'L') {
              row.style.color = 'yellow';
            } else if (data.div_cd == 'R') {
              row.style.color = 'aqua';
            }
          }
        });

        for (var i = 0; i < list.length; i++) {
          var iData = list[i].getData();
          for (var j = i + 1; j < list.length; j++) {
            var jData = list[j].getData();

            if (iData.status == 'P' && jData.status == 'P' && iData.sku_barcd == jData.sku_barcd) {
              this.needMpiScanCode.push(iData.sku_barcd);
            }
          }
        }
      }

      /**
       * @description 왼쪽으로 Swipe
       ******************
       * @param {Object} event
       */
      swipeLeft(event) {
        if (!this.inputList || this.inputList.length == 0) return;
        let startInputSeq = this.inputList[0].input_seq;
        let regionCd = LOGIS_UTIL.getRegionCd();
        let zoneCd = LOGIS_UTIL.getZoneCd();
        let sideCd = LOGIS_UTIL.getSideCd();
        let pageAjax = this.$['input-list-pages-ajax'];
        pageAjax.customParams = { show_others_order: LOGIS_UTIL.getShowOthersOrder() };
        pageAjax.curl = `/tablet_process/dps/input_pages/${regionCd}/${zoneCd}/${sideCd}/DOWN/${startInputSeq}`;
        pageAjax.generateRequest();
      }

      /**
       * @description 오른쪽으로 Swipe
       ******************
       * @param {Object} event
       */
      swipeRight(event) {
        if (!this.inputList || this.inputList.length == 0) return;
        let startInputSeq = this.inputList[this.inputList.length - 1].input_seq;
        let regionCd = LOGIS_UTIL.getRegionCd();
        let zoneCd = LOGIS_UTIL.getZoneCd();
        let sideCd = LOGIS_UTIL.getSideCd();
        let pageAjax = this.$['input-list-pages-ajax'];
        pageAjax.curl = `/tablet_process/dps/input_pages/${regionCd}/${zoneCd}/${sideCd}/UP/${startInputSeq}`;
        pageAjax.generateRequest();
      }

      /**
       * @description [완료] 버튼 클릭
       ******************
       * @param {Object} event
       */
      doneIconClicked(event) {
        const inspWithPickAjax = this.$['depart-ajax'];
        let scannedBarcode = this.selectedInput.bucket_cd;
        //if(this.selectedInput.status==='F') {
        let regionCd = LOGIS_UTIL.getRegionCd();
        let zoneCd = LOGIS_UTIL.getZoneCd();
        inspWithPickAjax.curl = `/tablet_process/dps/box_depart/${regionCd}/${zoneCd}/${scannedBarcode}`;
        inspWithPickAjax.generateRequest();
        //}
      }

      /**
       * @description 버킷 또는 박스가 스캔되면 scannded 호출하는 테스트 기능
       ******************
       * @return {[type]} [description]
       */
      _onBucketCodeChanged(event) {
        if (event.key === 'Enter') {
          this.scannedBarcode = event.currentTarget.value;
          event.currentTarget.select();
          this.scanned(this.scannedBarcode);
          SOUND.playInfoSound();
        }
      }

      /**
       * @description 블루투스 subscribe callback
       * 연결된 블루투스 장비에 의해 호출 됨
       * MpsBluetoothScannerMixin을 사용하는 컴퍼넌트는 scanned 함수를 구현해야함
       * @param {String} scannedBarcode 스캔한 상품 바/코드
       */
      scanned(scannedBarcode) {
        this.isMpiCd = this.mpiList.indexOf(scannedBarcode) >= 0;
        var needMpiCd = this.needMpiScanCode.indexOf(scannedBarcode) >= 0;

        //mpi코드 => MPI코드가 필요한지 && 필요한 mpi코드인지 체크 =>
        //mpi코드가 필요한 상품일 경우 =>
        if (needMpiCd || this.isMpiCd) {
          if (this.isMpiCd) {
            this.mpiCd = scannedBarcode;
            this.drawDecoLine(this.mpiCd);
            return;

          } else if (this.mpiCd == 'NaN') {
            document.dispatchEvent(new CustomEvent('show-toast', {
              detail: {
                type: t('error.no_scan_mpi_code'),
                message: t('error.no_scan_mpi_code')
              }
            }));
            return;
          }

        } else {
          if (scannedBarcode.indexOf('DONE_BY_QR') === 0) {
            this.doneIconClicked();
            return;

          } else if (/^[bcdfghiBCDFGHI][0-9]{7}$/.test(scannedBarcode)) {
            var event = {};
            event.detail = {};
            event.detail.sku_cd = scannedBarcode;
            this.skuSelected(event);
            return;
          }
        }

        this.drawDecoLine(this.mpiCd);
        this.$['sku-barcd'].value = scannedBarcode;
        this.$['sku-barcd']._triggerAjax();
      }

      /**
       * @description decoration라인 추가
       ******************
       * @param {String} searchItem decoration라인추가할 아이템
       */
      drawDecoLine(searchItem) {
        var mpsList = this.$['content'].getElementsByTagName('item-list');
        var allRows = [];
        allRows = allRows.concat(mpsList[0].getRows(), mpsList[1].getRows())
        allRows.forEach(row => {
          if (row.getData().mpi_cd == searchItem && row.getData().status == 'P') {
            if (row.classList.value.indexOf('complete') < 0) {
              row.classList.add('underline');
            }
          }
        })
      }

      /**
       * @description 스캔한 상품 바코드로 여러 개의 상품이 검색된 이후 하나의 상품을 선택시
       ******************
       * @param {Object} event
       */
      skuSelected(event) {
        const inspWithPickAjax = this.$['insp-with-pick-ajax'];
        let scannedBarcode = this.scannedBarcode = event.detail.sku_cd;
        let inputSeqId = this.selectedInput ? this.selectedInput.id : 'none';
        let regionCd = LOGIS_UTIL.getRegionCd();
        let zoneCd = LOGIS_UTIL.getZoneCd();
        let sideCd = LOGIS_UTIL.getSideCd();
        inspWithPickAjax.curl = `/tablet_process/dps/insp_with_pick/${regionCd}/${sideCd}/${zoneCd}/${inputSeqId}/${scannedBarcode}/${this.mpiCd}`;
        inspWithPickAjax.generateRequest();
      }

      /**
       * @description 웨어러블 검수 실패시
       ******************
       * @param {Object} event
       */
      _inspWithPickError(event) {
        this.mpiCd = 'NaN';
        var allRows = [];
        var mpsList = this.$['content'].getElementsByTagName('item-list');
        allRows = allRows.concat(mpsList[0].getRows(), mpsList[1].getRows())
        allRows.forEach(row => {
          row.classList.remove('underline');
        })
      }

      /**
       * 웨어러블 검수 응답시
       ******************
       * @param {Object} event
       */
      _inspWithPickResponsed(event) {
        if (event.detail.refresh_type === 'input-added') {
          this.boxId = this.scannedBarcode;
          this.scannedBarcode = '';
        }

        this.refreshByWs(event.detail.refresh_type);
      }

      /**
       * SKU 정보 조회 시 복수개가 조회된 경우 사용자가 고를 수 있는 버튼이 실행되는데 그 버튼에 표시할 내용
       *******************
       * @param {Object} item
       */
      _skuButtonTxtCallback(item) {
        return `(${item.sku_cd})
                ${item.sku_nm}`;
      }
    }

    customElements.define(B2cPickingJob.is, B2cPickingJob);
  </script>
</dom-module>
