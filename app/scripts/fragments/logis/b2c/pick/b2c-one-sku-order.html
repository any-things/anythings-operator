<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">

<script src="../../../../components/logis/logis-util.js"></script>

<!--
  물류 > B2C > 1 SKU - 1 Order 소분류 처리 화면 (PDA)
-->
<dom-module id="b2c-one-sku-order">
  <template>
    <style include="shared-styles">
      :host {
        display: flex;
        flex-direction: column;
        padding: 10px;
        height: calc(100% - 20px);
      }
      #container {
        display: flex;
        flex-direction: column;
        flex: 1;
        color: rgba(255,255,255,.8);
      }
      #summary-container {
        padding: 0px 5px 5px 5px;
      }
      #summary-container input[type=number] {
        text-align: right;
      }
      #input-container {
        display: flex;
        flex-direction: column;
        background-color: var(--things-white-opacity-background-color);
        padding: 5px;
        border-radius: var(--things-default-border-radius);
      }
      .input-row {
        display: flex;
        flex-direction: row;
        margin-bottom: 5px;
      }
      .input-row.last {
        margin-bottom: 0px;
      }
      .input-row .label {
        font-size: .8rem;
        margin: auto 5px auto auto;
        min-width: 25%;
        text-align: right;
      }
      .input-row input, .input-row auto-popup-input, .input-row select {
        width: 75%;
      }
      #box-type-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        padding: 10px 5px 5px 5px;
      }
      #box-type-container .label {
        font-size: .8rem;
      }
      #box-type-container p {
        margin: auto;
        font-size: 19vh;
      }
      #button-container {
        display: grid;
        justify-items: end;
      }
    </style>

    <sys-ajax
      id="summary-ajax"
      method="GET"
      hidden-spinner
      last-response="{{summary}}">
    </sys-ajax>

    <sys-ajax
      id="box-type-ajax"
      method="GET"
      on-sys-ajax-response="_boxTypeResponsed"
      on-sys-ajax-error="_resetView">
    </sys-ajax>

    <sys-ajax
      id="insp-ajax"
      method="PUT"
      on-sys-ajax-response="_handleSkuMappingResponse"
      on-sys-ajax-error="_handleSkuMappingError">
    </sys-ajax>

    <sys-ajax
      id="sku-map-ajax"
      method="GET"
      hidden-spinner
      on-sys-ajax-response="_handleSkuMappingResponse"
      on-sys-ajax-error="_handleSkuMappingError">
    </sys-ajax>

    <sys-ajax
      id="status-check-ajax"
      method="GET"
      hidden-spinner
      on-sys-ajax-response="_handleStatusResponse"
      on-sys-ajax-error="_handleStatusError">
    </sys-ajax>

    <div id="container">
      <div id="summary-container">
        <div class="input-row">
          <span class="label">[[totalSkuLabel]]</span>
          <input type="number" id="total-sku" readonly />
        </div>

        <div class="input-row">
          <span class="label">[[finishedSkuLabel]]</span>
          <input type="number" id="finished-sku" readonly />
        </div>
      </div>

      <div id="input-container">
        <div class="input-row">
          <span class="label">[[skuCdLabel]]</span>

          <auto-popup-input
            barcode
            hide-keyboard
            id="sku-cd"
            resource-url="[[getSkuAjaxUrl]]"
            popup-title="[[popupTitleLabel]]"
            button-txt-callback="[[_skuButtonTxtCallback]]"
            allowed-focus-out
            on-item-selected="_requestBoxType">
          </auto-popup-input>
        </div>

        <div class="input-row">
          <span class="label">[[skuNmLabel]]</span>
          <input id="sku-nm" readonly />
        </div>

        <div class="input-row">
          <span class="label">[[orderQtyLabel]]</span>
          <input id="order-qty" readonly />
        </div>

        <div class="input-row">
          <span class="label">[[boxIdLabel]]</span>
          <input id="box-id" on-focus = "_hideKeyboard" on-keypress="_handleKeypress" />
        </div>

        <div class="input-row last">
          <span class="label" >[[selectOrderLabel]]</span>
          <select id="order-list" on-change="_selectOrderList" >
            <option></option>
          </select>
        </div>

      </div>

      <div id="box-type-container">
        <span class="label">[[boxTypeLabel]]</span>
        <p>[[recomendedBoxType]]</p>
      </div>

      <div id="button-container">
        <button id="reset-btn" on-click="_resetView">[[resetBtnLabel]]</button>
      </div>
    </div>
  </template>

  <script>
    class B2COneSkuOrder extends BarcodeScannerMixin(Polymer.Element) {
      static get is() {
        return 'b2c-one-sku-order'
      }

      static get properties() {
        return {
          /**
           * 전체 SKU 라벨
           */
          totalSkuLabel: {
            type: String,
            value: () => `${t('label.total')} ${t('label.sku')}`
          },

          /**
           * 완료 SKU 라벨
           */
          finishedSkuLabel: {
            type: String,
            value: () => `${t('label.finished')} ${t('label.sku')}`
          },

          /**
           * SKU Code 라벨
           */
          skuCdLabel: {
            type: String,
            value: () => t('label.sku_cd')
          },

          /**
           * SKU Name 라벨
           */
          skuNmLabel: {
            type: String,
            value: () => t('label.sku_nm')
          },

          /**
           * 주문 수량 라벨
           */
          orderQtyLabel: {
            type: String,
            value: () => t('label.order_qty')
          },

          /**
           * Box ID 라벨
           */
          boxIdLabel: {
            type: String,
            value: () => t('label.box_id')
          },

          /**
           * Box 유형 라벨
           */
          boxTypeLabel: {
            type: String,
            value: () => t('label.box_type')
          },

          /**
           * 초기화 버튼 라벨
           */
          resetBtnLabel: {
            type: String,
            value: () => t('button.reset')
          },

          /**
           * SKU 조회 URL
           */
          getSkuAjaxUrl: {
            type: String,
            value: `/pda_process/find_sku/${LOGIS_UTIL.getEquipCd()}/:inputValue`
          },

          /**
           * auto-popup-input 팝업 출력시 팝업 타이틀 라벨
           */
          popupTitleLabel: {
            type: String,
            value: () => t('label.sku')
          },

          selectOrderLabel: {
            type: String,
            value: () => t('title.sku_selection')
          },

          /**
           * 추천 박스 타입
           */
          recomendedBoxType: {
            type: String
          },

          /**
           * Summary 조회 interval
           */
          intervalRequest: {
            type: Number,
            value: 10000
          },

          /**
           * SKU Summary response
           */
          summary: {
            type: Object,
            observer: '_summaryChanged'
          },
          skuCd: {
            type: String,
            value: ''
          }
        }
      }

      /**
       * 1. routing 변경시 또는 브라우저 새로고침 및 URL 직접 입력을 통해 화면 진입시
       *    summary 조회 interval setting
       * 2. routing 변경하여 다른 화면으로 이동시 clear interval
       */
      connectedCallback() {
          super.connectedCallback();
          //Summary 정보 자동 조회
          // document.addEventListener('page-changed', event => {
          //   if(event.detail.currentPage === 'pda_one_sku_order') {
          //     this._setRequestInterval();
          // } else {
          //     clearInterval(this.summaryRequestInterval);
          //   }
          // });

          // this._setRequestInterval();
          this.refreshSummary();
        }
        /**
         * summary 조회 요청 interval 등록
         */
      _setRequestInterval() {
        this.summaryRequestInterval = setInterval(() => {
          this.refreshSummary();
        }, this.intervalRequest);
      }

      /**
       * summary data 조회
       */
      refreshSummary() {
        const summaryAjax = this._getSummaryAjax();
        summaryAjax.curl = '/pda_process/qps/one_sku_order/sum'

        if (!summaryAjax.baseUrl) {
          summaryAjax.baseUrl = JSON.parse(localStorage.getItem('setting.baseUrl'));
        }
        summaryAjax.generateRequest();
      }

      /**
       * summary 조회 결과 변화시 input field에 입력
       */
      _summaryChanged(summary) {
        this._getTotalInput().value = summary.tot_qty;
        this._getFinishedInput().value = summary.comp_qty;
      }

      /**
       * auto-popup-input 팝업 버튼 구성을 위한 콜백
       */
      _skuButtonTxtCallback(item) {
        return `${item.com_cd} : ${item.sku_cd}
                ${item.sku_nm}`;
      }

      /**
       * SKU 정보를 input에 입력
       */
      _setSkuInfo(skuInfo) {
        this._getSkuNmInput().value = skuInfo.sku_nm;
        this.skuCd = this._getSkuCdInput().value = skuInfo.sku_barcd;
        // this._getBoxIdInput().value = skuInfo.box_id;
      }

      /**
       * 추천 박스 타입 조회 요청
       */
      _requestBoxType(event) {
          const skuInfo = event.detail;
          if (this.skuCd && this.skuCd == skuInfo.sku_barcd) {
            this._getSkuCdInput().value = skuInfo.sku_barcd;
            const inspAjax = this._getInspAjax();
            inspAjax.curl = `/pda_process/qps/one_sku_insp_with_pick/${this.mapId}`;
            inspAjax.generateRequest();
            // if()
          } else {
            this._setSkuInfo(skuInfo);
            const boxTypeAjax = this._getBoxTypeAjax();
            boxTypeAjax.curl = `/pda_process/qps/one_sku_order/scan_sku/${skuInfo.com_cd}/${skuInfo.sku_cd}`;
            boxTypeAjax.generateRequest();
          }

        }
        /**
         * 추천 Box 조회 요청에 대한 response handler
         */
      _boxTypeResponsed(event) {
        var item = event.detail;
        this.orderList = event.detail.order_list;
        const orderCombo = this._getOrderListCombo();
        this._clearCombobox(orderCombo);
        this.orderList.forEach(order => {
          const option = document.createElement('option');
          option.innerText = order.batch_id + ' / ' + order.order_qty;
          option.setAttribute('order-pcs', order);
          orderCombo.appendChild(option);
        });
        this.picking_qty = item.picking_qty;
        this.order_qty = item.order_qty;
        this._getBoxIdInput().value = item.box_id;
        this._getOrderQtyInput().value = this.picking_qty + '/' + this.order_qty;
        this.mapId = item.id;
        this.recomendedBoxType = item.box_type_cd;
        if (item.status == 'PICKING') {
          this._getSkuCdInput().select();
        } else if (item.status == 'PICKED') {
          this.mapId = null;
          this._resetView();
          this._getBoxIdInput().select();
          document.dispatchEvent(new CustomEvent('show-toast', {
            detail: {
              title: t('text.order_already_picked'),
              message: t('text.order_already_picked')
            }
          }));
        } else if (item.status == 'READY') {
          this._getBoxIdInput().select();
        }
      }

      /**
       * input on-keypress event handler
       * box-id 입력시 sku & box 맵핑을 요청함
       */
      _handleKeypress(event) {
        if (event.keyCode === 13) {
          if (this.order_qty < this.picking_qty) {
            document.dispatchEvent(new CustomEvent('show-toast', {
              detail: {
                title: t('text.reprint_error_msg_1'),
                message: t('text.reprint_error_msg_1'),
              }
            }));
            this._getSkuCdInput().select();
          } else {
            const boxId = event.currentTarget.value;
            var boxInput = this._getBoxIdInput();
            if (/^[bcdfghiBCDFGHI][0-9]{7}$/.exec(boxId)) {
              try {
                if (!boxId) throw t('error.box_id_invalid');
                if (!this._validateBoxId(boxId)) throw t('error.not_recommanded_box');
                this._requestSkuMapping(boxId)
              } catch (error) {
                boxInput.value = '';
                boxInput.select();
                this._commonAlert(error)
              }
            } else {
              document.dispatchEvent(new CustomEvent('show-toast', {
                detail: {
                  title: t('title.box_form_check'),
                  message: t('text.box_form_check'),
                }
              }));
              this._getSkuCdInput().value = boxInput.value;
              boxInput.value = '';
              this._getSkuCdInput().select();
            }
          }

        }
      }

      /**
       * SKU & Box 맵핑 요청 전
       * 올바른 Box를 스캔 했는지 확인하기 위한 validation
       */
      _validateBoxId(boxId) {
        return boxId.startsWith(this.recomendedBoxType)
      }


      /**
       * SKU, Box 간 맵핑 요청
       * 1. 맵핑 요청을 수행하고 스피너를 토글
       * 2. 토글 된 스피너는 명시적으로 close 해야만 사라지는 msg-spinner
       */
      _requestSkuMapping(boxId) {
        const skuMappingAjax = this._getSkuMappingAjax();
        if (!this.mapId) {
          this.mapId = 'NaN';
        }
        skuMappingAjax.curl = `/pda_process/qps/one_sku_order/scan_box/${this.mapId}/${boxId}`;
        skuMappingAjax.generateRequest();
      }

      /**
       * SKU Mapping 요청 response handler
       * 맵핑 상태를 확인하기 위해 _requestStatusCheck 호출
       */
      _handleSkuMappingResponse(event) {
        var item = event.detail;

        if (item.status == 'MAPPING') {
          this.mapId = item.id;
          this._toggleMessageSpinner(t('label.please_wait'));
          this._requestStatusCheck();

        } else if (item.status == 'PICKING') {
          this._getOrderQtyInput().value = item.picking_qty + '/' + item.order_qty;
          this._getSkuCdInput().select();

        } else if (item.status == 'CANCEL') {
          document.dispatchEvent(new CustomEvent('show-toast', {
            detail: {
              type: t('text.sku_canceled'),
              message: t('text.sku_canceled'),
            }
          }));
          this._resetView();
        }
      }

      _selectOrderList(event) {
        var i = this._getOrderListCombo().selectedIndex;
        var selectOrder = this.orderList[i];
        this.picking_qty = selectOrder.picking_qty;
        this.order_qty = selectOrder.order_qty;
        this.mapId = selectOrder.id;
        this._getBoxIdInput().value = selectOrder.box_id;
        this._getOrderQtyInput().value = this.picking_qty + '/' + this.order_qty;
        this.recomendedBoxType = selectOrder.box_type_cd;
        if (selectOrder.box_id == ' ') {
          this._getBoxIdInput().select();
        } else {
          this._getSkuCdInput().select();
        }

      }

      /**
       * 맵핑 요청에 대한 error handler
       * 에러 발생시 화면에 나타난 msg-spinner를 close
       */
      _handleSkuMappingError(e) {
        if (e.detail.success == false) {
          this._getBoxIdInput().select();
        }
        this._toggleMessageSpinner();
      }

      /**
       * 맵핑 상태를 체크하기 위해 요청
       */
      _requestStatusCheck() {
        const statusCheckAjax = this._getStatusCheckAjax();
        statusCheckAjax.curl = `/pda_process/qps/one_sku_order/map_status/${this.mapId}`;
        statusCheckAjax.generateRequest();
      }

      /**
       * 맵핑 상태 요청에 대한 response handler
       * 상태가 MAPPING일 경우 맵핑 대기중인 상태
       * 상태가 END일 경우 맵핑이 완료된 상태
       * 맵핑 상태가 END가 나올때 까지 상태 확인 요청을 수행함
       * 맵핑이 완료 되어 서버로 부터 END 상태를 전달 받으면 msg-spinner를 close
       *
       * 맵핑 상태
       * MAPPING : 재고 맵핑 대기
       * END : 작업 맵핑 완료
       */
      _handleStatusResponse(event) {
        if (event.detail.status.toUpperCase() === 'MAPPING') {
          setTimeout(() => {
            this._requestStatusCheck()
          }, 3000);

        } else if (event.detail.status.toUpperCase() === 'END') {
          this.mapId = null;
          this._toggleMessageSpinner();
          this.refreshSummary();
          document.dispatchEvent(new CustomEvent('show-toast', {
            detail: {
              type: t('text.box_mapping_complete'),
              message: t('text.box_mapping_complete'),
            }
          }));
          this._resetView();
        } else if (event.detail.status.toUpperCase() === 'PICKING') {
          this._getSkuCdInput().select();
          document.dispatchEvent(new CustomEvent('show-toast', {
            detail: {
              type: t('text.box_mapping_complete'),
              message: t('text.box_mapping_complete'),
            }
          }));
        }
      }

      /**
       * 맵핑 상태가 비정상일 경우 에러를 발생시킴
       * 에러 발생시 msg-spinner를 close함
       *
       * 맵핑 에러 상태
       * LOC : location 에 상품 없음
       * STOCK : 재고가 부족함
       */
      _handleStatusError() {
        var boxInput = this._getBoxIdInput();
        // boxInput.value='';
        // boxInput.select();
        this._getSkuCdInput().select();
        this.skuCd = '';
        this._resetView();
        this.skuCd = '';
        this._toggleMessageSpinner();
        this.refreshSummary();
      }

      /**
       * 메시지를 포함한 스피너를 toggle
       * 메시지가 있을 경우 스피너를 open, 없을 경우 close
       */
      _toggleMessageSpinner(message) {
        document.dispatchEvent(new CustomEvent('toggle-msg-spinner', {
          detail: {
            active: message ? true : false,
            message: message
          }
        }));
      }

      /**
       * alert 출력을 위한 공통 function
       */
      _commonAlert(message) {
        openAlert({
          title: t('error.VALIDATION_ERROR'),
          message: message,
          confirmCallback: () => {
            this._getBoxIdInput().select()
          }
        });
      }

      /**
       * 초기화 버튼 click event handler
       * 화면 클리어 및 변수 초기화
       */
      _resetView() {
        this._getSkuCdInput().value = '';
        this._getSkuNmInput().value = '';
        this._getBoxIdInput().value = '';
        this._getOrderQtyInput().value = '';
        this.recomendedBoxType = '';
        this._initialSetup();
        this.skuCd = '';
        this._clearCombobox(this._getOrderListCombo());
      }
      _clearCombobox(combobox) {
        while (combobox.children.length) {
          combobox.removeChild(combobox.firstChild);
        }
      }
      _hideKeyboard(event) {
        const inputElement = event.currentTarget;
        inputElement.setAttribute('readonly', '');
        setTimeout(() => {
          inputElement.removeAttribute('readonly');
        }, 100)
      }

      _getSummaryAjax() {
        return this.$['summary-ajax']
      }

      _getTotalInput() {
        return this.$['total-sku'];
      }
      _getFinishedInput() {
        return this.$['finished-sku'];
      }

      _getBoxTypeAjax() {
        return this.$['box-type-ajax'];
      }

      _getInspAjax() {
        return this.$['insp-ajax'];
      }

      _getSkuMappingAjax() {
        return this.$['sku-map-ajax'];
      }

      _getStatusCheckAjax() {
        return this.$['status-check-ajax']
      }

      _getSkuCdInput() {
        return this.$['sku-cd'];
      }

      _getOrderQtyInput() {
        return this.$['order-qty']
      }

      _getSkuNmInput() {
        return this.$['sku-nm'];
      }

      _getBoxIdInput() {
        return this.$['box-id'];
      }

      _getOrderListCombo() {
        return this.$['order-list'];
      }
    }

    customElements.define(B2COneSkuOrder.is, B2COneSkuOrder)
  </script>
</dom-module>