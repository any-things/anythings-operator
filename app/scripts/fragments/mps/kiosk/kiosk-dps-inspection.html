<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../kiosk-libraries.html">

<link rel="import" href="./kiosk-inspection-input-count.html">

<dom-module id="kiosk-dps-inspection">
  <template>
    <style>
      .container {
        /* height: calc(100% - 40px); */
        height: calc(100% - 20px);
        padding: 10px;
        display: flex;
        flex-direction: column;
      }
      .input-section {
        display:grid;
        grid-template:1.1fr / 1.4fr 1fr 1fr 1fr;
        background-color:#5a6378;
        border-radius:var(--things-default-border-radius);
        overflow: hidden;
        margin-bottom: 10px;
        /* padding:10px; */
        padding: 7px;
      }
      #bottom-container {
        flex: 1;
        display: grid;
        grid-template-columns: 4fr 1fr;
        grid-gap: 20px;
        /* padding: 9px 7px 7px 0; */
        /* padding: 0; */
        border-radius:var(--things-default-border-radius);
        /* margin-bottom: 20px; */
      }

      .input-section div{
        text-align:center;
        color:#fff;
      }
      .input-section .sku-info span{
        display:block;
      }
      .input-section .sku-info{
        border-left:1px solid rgba(0,0,0,.3);
      }
      .input1 span{
        display:inline-block;
        width:30%;
        text-align:right;
        font-size:.6rem
      }
      .input1 input{
        display:inline-block;
        width:62%;height:40px;
        margin-bottom:5px
      }
      span.bigtitle{
        margin:20px 0 15px 0;
        font-size:0.9rem;
      }
      span.smalltitle{
        margin:15px 0 15px 0;
        font-size:.7rem;
      }
      span.bigtitle,span.smalltitle{
        display:inline-block !important;
        border-bottom:3px solid var(--things-secondary-color);
      }
      span.proc{
        font-size:1.2rem;
        color:rgba(255,255,255,.7);
      }
      span.proc b{
        display:inline-block;
        text-align:right;
        color:#fff;
      }
      span.proc-reject{
        font-size:1.2rem;
        color:rgba(255,255,255,.7);
      }
      span.proc-reject b{
        display:inline-block;
        text-align:right;
        color:#f00;
      }
      .right-section{
        display:grid;
        grid-template-rows: auto min-content;
      }
      .right-section .radio-section{
        grid-row-start:1;
      }
      .radio-section label{
        font-size:.8rem;
        color:rgba(255,255,255,.8);
      }
      .radio-section input{
        position: relative;
        top: -7px;
      }
      #label {
        text-align: right;
        color: #D5D7DB;
        font-size: 25pt;
        margin: auto 15px auto 0;
      }
      .btn-section {
        display: flex;
        flex-direction: column;
      }
      button {
        @apply --operator-default-btn;
        margin-top: 15px;
        flex: 1;
      }
      button:active {
        @apply --operator-default-btn-active;
      }
      button:focus{
        outline:none
      }
      input {
        background-color: #474E5E;
        border: 1px solid #748094;
        color: #fff;
        font-size: .8rem;
        text-align: center;
      }
      mps-auto-popup-input {
        display: none
      }
      mps-list {
        height: 100%;
      }
    </style>

    <!-- 송장 번호로 검수 정보 조회를 위한 Ajax -->
    <sys-ajax
      id="inspection-items-ajax"
      curl="/kiosk_process/dps/inspection/by_qty/ready/by_order/:order_id"
      method="GET"
      content-type="application/json"
      last-response="{{inspection}}"
      custom-error-handler
      on-sys-ajax-error="onInspectionError">
    </sys-ajax>

    <!-- 검수 완료를 위한 Ajax -->
    <sys-ajax
      id="inspection-complete-ajax"
      curl="/kiosk_process/dps/inspection/by_qty/finish/:order_id"
      method="PUT"
      content-type="application/json"
      last-response="{{inspectionResult}}">
    </sys-ajax>

    <!-- 송장 재발행을 위한 Ajax -->
    <sys-ajax
      id="reprint-invoice-ajax"
      curl="/kiosk_process/dps/inspection/print/:order_id"
      method="PUT"
      content-type="application/json"
      on-sys-ajax-response="_reprintSucceed">
    </sys-ajax>

    <!-- 박스 분할을 위한 Ajax -->
    <sys-ajax
      id="split-box-ajax"
      curl="/kiosk_process/dps/inspection/split_box/:order_id"
      method="PUT"
      content-type="application/json"
      on-sys-ajax-response="_splitBoxResponsed">
    </sys-ajax>

    <!-- 상품 추가작업을 위한 Ajax -->
    <sys-ajax
      id="add-sku-ajax"
      curl=""
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_addSkuResponsed">
    </sys-ajax>

    <sys-ajax
      id="change-status-ajax"
      curl="/kiosk_process/dps/inspection/by_qty/again/:box_type/:box_id"
      method="PUT"
      content-type="application/json">
    </sys-ajax>

    <div class="container">
      <div class="input-section" id="input-section">
        <div class="input1">
            <span class="label">[[bucketCdLabel]]</span>
            <input id="bucket-cd" on-keypress="_onBarcodeScan">
            <span class="label">[[orderIdLabel]]</span>
            <input id="order-cd" on-keypress="_onOrderIdScan">
            <span class="label">[[skuBarcdLabel]]</span>
            <input id="sku-barcode" on-keypress="_onBarcodeScan">
            <!-- SKU 정보 조회 시 복수개가 조회된 경우 실행되는 사용자가 고를 수 있는 팝업이 가미된 SKU Input -->
            <mps-auto-popup-input
              id="sku-bcd"
              resource-url="[[getSkuAjaxUrl]]"
              popup-title="[[popupTitleLabel]]"
              button-txt-callback="[[_skuButtonTxtCallback]]"
              allowed-focus-out
              on-item-selected="_onSkuBarcodeScan">
            </mps-auto-popup-input>
        </div>

        <div class="sku-info">
          <span class="smalltitle">[[skuCntLabel]]</span>
          <span class="proc"><b>[[pickedSkuCnt]]</b> / [[confirmSkuCnt]]</span>
        </div>
        <div class="sku-info">
          <span class="smalltitle">[[skuQtyLabel]]</span>
          <span class="proc"><b>[[pickedSkuPcsQty]]</b> / [[confirmSkuPcsQty]]</span>
        </div>
        <div class="sku-info">
          <span class="smalltitle">[[bucketCdLabel]]</span>
          <span class="proc"><b>[[currentBucketCd]]</b></span>
        </div>
        <template is="dom-if" if="[[jobType]]">
          <div class="sku-info">
            <span class="smalltitle">[[skuWeightLabel]]</span>
              <template is="dom-if" if="[[!rejectStatus]]">
                <span class="proc"><b>[[skuWeight]]</b> ([[skuMinimumWeight]] ~ [[skuMaximumWeight]])</span>
              </template>
              <template is="dom-if" if="[[rejectStatus]]">
                <span class="proc-reject"><b>[[skuWeight]]</b> ([[skuMinimumWeight]] ~ [[skuMaximumWeight]])</span>
              </template>
          </div>
        </template>
      </div>

      <div id="bottom-container">
        <mps-list
          header="[[header]]"
          data="[[items]]"
          on-configured="_addCompleteClass">
        </mps-list>
        <div class="right-section">
          <div class="radio-section">
              <input type="radio" on-click="_handleInspectionMethodClick" name="chk_info" value="each" checked="checked" id="each">
              <label for="each">[[indivisualLabel]]</label><br/>
                <!-- <input type="radio" on-click="_handleInspectionMethodClick" name="chk_info" value="total" id="total">
                <label for="total">[[batchLabel]]</label><br/>
                <input type="radio" on-click="_handleInspectionMethodClick" name="chk_info" value="inputCount" id="inputCount">
                <label for="inputCount">[[qtyInputLabel]]</label><br/>
                <input type="radio" on-click="_handleInspectionMethodClick" name="chk_info" value="addSku" id="addSku">
                <label for="addSku">[[addSkuLabel]]</label> -->
          </div>
          <div class="btn-section">
            <template is="dom-if" if="[[jobType]]">
                <button id="inspection-btn" on-click="searchSBS">[[sbsLabel]]</button>
            </template>
            <button id="inspection-btn" on-click="completeInspection">[[completeLabel]]</button>
            <button id="retry-inspection-btn" on-click="changeInspectionStatus">[[retryInspectionLabel]]</button>
            <button id="reset-btn" on-click="reset">[[resetLabel]]</button>
            <button id="reset-all-btn" on-click="resetAll">[[resetAllLabel]]</button>
            <button id="reprint-btn" on-click="reprint">[[reprintLabel]]</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    class KioskDpsInspection extends Polymer.Element {
      static get is() { return 'kiosk-dps-inspection' }

      static get properties() {
        return {
          /**
           * 버킷 번호 라벨
           ****************
           * @type {String}
           */
          bucketCdLabel: {
            type: String,
            value: t('label.bucket_cd')
          },

          /**
           * 상품 중량 라벨
           ****************
           * @type {String}
           */
          skuWeightLabel: {
            type: String,
            value: t('label.sku_weight')
          },

          /**
           * 주문 번호 라벨
           ****************
           * @type {String}
           */
          orderIdLabel: {
            type: String,
            value: t('label.order_id')
          },

          /**
           * 상품 바코드 라벨
           ****************
           * @type {String}
           */
          skuBarcdLabel: {
            type: String,
            value: t('label.sku_barcd')
          },

          /**
           * 상품 개수 라벨
           ****************
           * @type {String}
           */
          skuCntLabel: {
            type: String,
            value: t('label.sku_cnt')
          },

          /**
           * 상품 수량 라벨
           ****************
           * @type {String}
           */
          skuQtyLabel: {
            type: String,
            value: t('label.sku_qty')
          },

          /**
           * 검수 완료 라벨
           ****************
           * @type {String}
           */
          completeLabel: {
            type: String,
            value: t('button.inspection_complete')
          },

          /**
           * SBS 박스 조회 라벨
           ****************
           * @type {String}
           */
           sbsLabel: {
            type: String,
            value: t('button.search_sbs')
          },

          /**
           * 초기화 라벨
           ****************
           * @type {String}
           */
          resetLabel: {
            type: String,
            value: t('button.reset')
          },

          /**
           * 전체 초기화 라벨
           ****************
           * @type {String}
           */
          resetAllLabel: {
            type: String,
            value: t('button.reset_all')
          },

          /**
           * 재발행 라벨
           ****************
           * @type {String}
           */
          reprintLabel: {
            type: String,
            value: t('button.reprint')
          },

          /**
           * 개별처리 라벨
           ****************
           * @type {String}
           */
          indivisualLabel: {
            type: String,
            value: t('button.indivisual')
          },

          /**
           * 일괄처리 라벨
           ****************
           * @type {String}
           */
          batchLabel: {
            type: String,
            value: t('button.batch')
          },

          /**
           * 수량 입력처리 라벨
           ****************
           * @type {String}
           */
          qtyInputLabel: {
            type: String,
            value: t('button.qty_input')
          },

          /**
           *  상품 추가처리 라벨
           ****************
           * @type {String}
           */
          addSkuLabel: {
            type: String,
            value: t('button.add_sku')
          },

          /**
           *  검수 상태 변경 버튼 라벨
           ****************
           * @type {String}
           */
           retryInspectionLabel: {
            type: String,
            value: t('button.retry_inspection')
          },

          /**
           * 스캔한 주문 번호
           ****************
           * @type {String}
           */
          currentOrderId: {
            type: String,
            value: ''
          },

          /**
           * 주문 번호와 매핑된 버킷 코드
           ****************
           * @type {String}
           */
          currentBucketCd: {
            type: String,
            value: ''
          },

          /**
           * 상품 중량
           ****************
           * @type {Number}
           */
          skuWeight: {
            type: Number,
            value: 0
          },

          /**
           * 상품 최대 중량
           ****************
           * @type {Number}
           */
          skuMaximumWeight: {
            type: Number,
            value: 0
          },

          /**
           * 상품 최소 중량
           ****************
           * @type {Number}
           */
          skuMinimumWeight: {
            type: Number,
            value: 0
          },

          /**
           * 이전 스캔한 상품 코드
           ****************
           * @type {String}
           */
          prevSkuBarcode: {
            type: String
          },

          /**
           * 피킹한 상품 수
           ****************
           * @type {Number}
           */
          pickedSkuCnt: {
            type: Number,
            value: 0
          },

          /**
           * 피킹한 상품 낱개 수
           ****************
           * @type {Number}
           */
          pickedSkuPcsQty: {
            type: Number,
            value: 0
          },

          /**
           * 확인 상품 수
           ****************
           * @type {Number}
           */
          confirmSkuCnt: {
            type: Number,
            value: 0
          },

          /**
           * 확인 상품의 낱개 수
           ****************
           * @type {String}
           */
          confirmSkuPcsQty: {
            type: Number,
            value: 0
          },

          /**
           * 검수 방법
           ****************
           * @type {String}
           */
          inspectionMethodValue: {
            type: String,
            value: 'each'
          },

          /**
           * 검수 결과
           ****************
           * @type {Object}
           */
          inspectionResult: {
            type: Object,
            observer: '_inspectionResultChanged'
          },

          /**
           * 그리드 헤더 정의
           ****************
           * @type {Array}
           */
          header: {
            type: Array,
            value: function() {
              return [{
                display: t('label.sku_cd'),
                fieldname: 'sku_cd',
                style: {
                  color: '#fff',
                  textAlign: 'left'
                },
                columnWidth: '180px'
              }, {
                display: t('label.sku_nm'),
                fieldname: 'sku_nm',
                style: {
                  color: '#ADCBEB',
                  textAlign: 'left'
                }
              }, {
                display: t('label.sku_barcd'),
                fieldname: 'sku_barcd',
                style: {
                  textAlign: 'center'
                },
                columnWidth: '300px'
              }, {
                display: t('label.order_qty'),
                fieldname: 'item_qty',
                style: {
                  textAlign: 'right'
                },
                columnWidth: '110px'
              }, {
                display: t('label.confirm_qty'),
                fieldname: 'confirm_qty',
                style: {
                  textAlign: 'right'
                },
                columnWidth: '100px'
              }, {
                display: t('label.diff_qty'),
                fieldname: 'diff_qty',
                style: {
                  textAlign: 'right'
                },
                columnWidth: '80px'
              }]
            }
          },

          /**
           * 그리드 데이터
           ****************
           * @type {Array}
           */
          items: {
            type: Array
          },

          /**
           * 그리드 데이터를 위한 소스 데이터
           ****************
           * @type {Array}
           */
          inspection: {
            type: Object,
            observer: '_inspectionChanged'
          },
          /**
           * SKU 정보 조회를 위한 URL
           ****************
           * @type {String}
           */
           getSkuAjaxUrl: {
            type: String,
            value : `/pda_process/find_sku/${LOGIS_UTIL.getRegionCd()}/:inputValue`
          },
          /**
           * SKU 정보 조회 후 복수개가 조회된 경우 사용자가 고를 수 있는 팝업이 실행되는데 그 팝업에 표시할 타이틀
           ****************
           * @type {String}
           */
           popupTitleLabel: {
            type: String,
            value: () => t('label.sku')
          },
        }
      }
      _onBarcodeScan(e){
        if (e.key != 'Enter') return;

        if(/^[bcdfghiBCDFGHI][0-9]{7}$/.exec(e.currentTarget.value)){
          this.$['bucket-cd'].value = e.currentTarget.value;
          if(this.$['sku-barcode'] === e.currentTarget){
            this.$['sku-barcode'].value = '';
          }
          this._onBucketCdScan(e)
        }else{
          this.$['sku-barcode'].value = e.currentTarget.value;
          this.$['sku-bcd'].value = e.currentTarget.value;
          this.$['sku-bcd']._triggerAjax();
        }
      }
      /**
       * 최초 코드
       */
      connectedCallback() {
        super.connectedCallback();
        document.addEventListener('page-changed', event => {
          if(event.detail.currentPage === location.hash.replace('#/', '')) {
            this.focusBucketInput();
          }
        });

        document.addEventListener(`alert-closed-at-${location.hash.replace('#/', '')}`, event => {
          if(!event.detail.hasCallback) {
            this.focusBucketInput();
          }
        });

        this.focusBucketInput();
      }

      /**
       * 버킷 코드 스캔시
       *****************
       * @param {Object} e
       */
      _onBucketCdScan(e) {
        // if (e.key != 'Enter') return;
        this.refreshInspection(this.$['bucket-cd'].value);
      }

      /**
       * 검수 화면 데이터 조회
       ************
       * @param {String} bucketCd
       */
      refreshInspection(bucketCd) {
        try {
          this.bucketCd = bucketCd;
          this.validateBeforeBucketScan();
          var ajaxLabel = this.$['inspection-items-ajax'];
          var inputType = LOGIS_UTIL.getKioskInputType();
          ajaxLabel.curl = '/kiosk_process/dps/inspection/by_qty/ready/by_box/' + inputType + '/' + this.bucketCd;
          ajaxLabel.generateRequest();
        } catch (error) {
          this.showMessage(error.title, error.message, error.confirmCallback);
        }
      }

      /**
       * 박스 ID 스캔 전 Validation Check
       */
      validateBeforeBucketScan() {
        if(!this.bucketCd || this.bucketCd.length < 4) {
          throw {
            title: t('error.VALIDATION_ERROR'),
            message: t('error.bucket_cd_invalid'),
            confirmCallback: this.focusBucketInput.bind(this)
          }
        }
      }

      /**
       * 버킷 코드 스캔 에러시
       **************
       * @param {Object} event
       */
      onInspectionError(event) {
        this.clearView();
        this.showMessage(event.detail.code, event.detail.msg, this.focusBucketInput.bind(this))
      }

      /**
       * 주문 번호 스캔시
       *****************
       * @param {Object} e
       */
      _onOrderIdScan(e) {
        if (e.key != 'Enter') return;
        try {
          this.orderId = e.currentTarget.value;
          this.validateBeforeOrderScan();
          var ajaxLabel = this.$['inspection-items-ajax'];
          ajaxLabel.curl = '/kiosk_process/dps/inspection/by_qty/ready/by_order/' + this.orderId;
          ajaxLabel.generateRequest();
        } catch (error) {
          this.showMessage(error.title, error.message, error.confirmCallback);
        }
      }

      /**
       * 주문 번호 스캔 전 Validation Check
       */
      validateBeforeOrderScan() {
        if(!this.orderId || this.orderId < 5) {
          throw {
            title: t('error.VALIDATION_ERROR'),
            message: t('error.order_id_invalid'),
            confirmCallback: this.focusOrderInput.bind(this)
          }
        }
      }

      /**
       * 상품 바코드 스캔시
       *****************
       * @param {Object} e
       */
      _onSkuBarcodeScan(e) {
        // if (e.key != 'Enter') return;

        // this.items (검수 대상 리스트)가 존재 하지 않는다면 alert
        if(!this.items || this.items.length == 0) {
          e.currentTarget.value = '';
          this.showMessage(t('error.VALIDATION_ERROR'), t('text.target_not_exist'), this.focusBucketInput.bind(this));
          return;
        }

        let skuBarcode = e.currentTarget.value;
        let found = this.items.find((item) => {
          return (item.sku_cd === skuBarcode || item.sku_barcd === skuBarcode);
        });

        // found (검수 대상 리스트 중 입력한 상품 코드와 일치하는 것)가 없다면 alert
        if(!found || found.length == 0) {
          this.showMessage(t('error.invalid_sku_cd'), t('text.scanned_sku_code_not_exist'), this.focusSkuBarcdInput.bind(this));
          return;
        }

        this.prevSkuBarcode = skuBarcode;
        let errorFlag = false;
        let finishedItem = null;
        var flag = 0;
        let newItems = this.items.map((item, index) => {
          if(skuBarcode == item.sku_cd || skuBarcode == item.sku_barcd) {
            if(flag >=1){
              return item;
            }
            if(item.diff_qty == 0) {
              this.showMessage(t('error.out_of_valid_qty'), t('text.confirm_qty_out_of_item_qty'), this.focusSkuBarcdInput.bind(this));
              errorFlag = true;
              return null;
            }

            if(this.inspectionMethodValue == 'each') {
              item.confirm_qty = ++item.confirm_qty;
              this.confirmSkuPcsQty = this.confirmSkuPcsQty + 1;
              flag++;
            } else if(this.inspectionMethodValue == 'total') {
              var calcQty = item.item_qty - item.confirm_qty;
              item.confirm_qty = item.item_qty;
              this.confirmSkuPcsQty = this.confirmSkuPcsQty + calcQty;

            } else if(this.inspectionMethodValue == 'inputCount') {
              const inputCountPopup = document.createElement('kiosk-inspection-input-count');
              inputCountPopup.item = item;

              if(item.sku_cd == skuBarcode || skuBarcode == item.sku_barcd) {
                document.dispatchEvent(new CustomEvent('open-dialog', {
                  detail: {
                    content: inputCountPopup,
                    width: 'fit',
                    height: 'fit',
                    title: this.qtyInputLabel,
                    openCallback: () => {
                      inputCountPopup._initialSetup();
                    },
                    closeCallback: () => {
                      let inputQty = inputCountPopup.inputQty;
                      if(!inputQty) {
                        this.focusSkuBarcdInput();
                        return;
                      }
                      this.confirmSkuPcsQty = this.confirmSkuPcsQty + inputQty;
                      if(this.items[index].diff_qty > 0) {
                        this.items[index].diff_qty = this.items[index].item_qty - this.items[index].confirm_qty;
                        if(this.items[index].diff_qty == 0) {
                          this.confirmSkuCnt = this.confirmSkuCnt + 1;
                          finishedItem = this.items[index];
                        }
                      }

                      let countItems = this.items;

                      if(!errorFlag) {
                        if(finishedItem) {
                          countItems.splice(countItems.indexOf(finishedItem), 1);
                          countItems.push(finishedItem);
                        }
                      }

                      this.set('items', []);
                      this.set('items',countItems);

                      this.focusSkuBarcdInput();
                      // 모든 검수가 완료 되었는지 확인하고 완료 되었다면 자동으로 검수 완료 처리
                      if(this.checkFinished(this.items)) {
                        this.completeInspection();
                      }
                    }
                  }
                }));
              }

            }else if(this.inspectionMethodValue == 'addSku'){
              //바코드를 스캔할 때마다 상품 추가작업
              let pickAjax = this.$['add-sku-ajax'];
              pickAjax.curl = '';

            }
            if(this.inspectionMethodValue != 'inputCount') {
              if(item.diff_qty > 0) {
                item.diff_qty = item.item_qty - item.confirm_qty;
                if(item.diff_qty == 0) {
                  this.confirmSkuCnt = this.confirmSkuCnt + 1;
                  finishedItem = item;
                  flag++;
                }
              }
            }
          }
          return item;
        });

        // 오류가 없고 항목이 완료되었다면 완료된 항목은 아래로 이동 - 소팅
        if(!errorFlag) {
          if(finishedItem) {
            newItems.splice(newItems.indexOf(finishedItem), 1);
            newItems.push(finishedItem);
          }
          this.items = newItems;
        }
        this.$['sku-barcode'].value = '';
        // 모든 검수가 완료 되었는지 확인하고 완료 되었다면 자동으로 검수 완료 처리
        if(this.checkFinished(this.items)) {
          this.completeInspection();
        }
      }

      /**
       * 검수 완료 체크
       * @param {Array} items
       ***************
       */
      checkFinished(items) {
        let finished = true;
        for(let i = 0; i < items.length; i++) {
          if(items[i].diff_qty > 0) {
            finished = false;
            break;
          }
        }

        return finished;
      }

      /**
       * 상품 추가 완료 체크
       * @param {Array} items
       ***************
       */
       _addSkuResponsed(items) {
        //피킹이 완료되면 검수완료 작업.
        if(items.length <=0){
          this.completeInspection();
        }
      }

      /**
       * 검사항목 정보 및 내품 내역 정보 변경 핸들러
       *****************
       * @param {Object} inspection
       */
      _inspectionChanged(inspection) {
        if(inspection == null) return;
        if(!(/([BRES])/.test(inspection.status))){
          document.dispatchEvent(new CustomEvent('show-toast',{
              detail:{
                type: t('text.cannot_inspection_now'),
                message: t('text.cannot_inspection_now')
              }
            }));
            this.clearView();
            this.focusBucketInput();
            return;
        }
        this.currentOrderId = inspection.order_id;
        this.custOrderId = inspection.cust_order_id;
        this.currentBucketCd = inspection.box_id;
        this.$['order-cd'].value = this.currentOrderId;
        this.$['bucket-cd'].value = this.currentBucketCd;
        if(inspection.job_type === 'QPS') {
          this.jobType = true;
          if(inspection.status === 'R') this.rejectStatus = true;
          else this.rejectStatus = false;
        } else {
          this.jobType = false;
        }

        let inspItems = inspection.items ? inspection.items : [];
        let skuPcs = 0;

        this.inspectionStatus = inspection.status;
        if(this.inspectionStatus === 'B' || this.inspectionStatus === 'R') {
          this.$['inspection-btn'].hidden = false;
          this.$['reset-btn'].hidden = false;
          this.$['reset-all-btn'].hidden = false;
        } else {
          this.$['inspection-btn'].hidden = true;
          this.$['reset-btn'].hidden = true;
          this.$['reset-all-btn'].hidden = true;
          //화면에서 완료된건은 빨강색으로 표현이 되기에 아래 메시지 필요 없음, 송장프린트는 별도 기능으로 처리
          // LOGIS_UTIL.showMessage(t('error.already_processed'), t('text.can_re_issue_invoice'), this.focusBucketInput.bind());
        }

        this.items = inspItems.map((item) => {
          this.inspectionStatus === 'E' || this.inspectionStatus === 'S' ? item.confirm_qty = item.item_qty : item.confirm_qty = 0;
          this.inspectionStatus === 'E' || this.inspectionStatus === 'S' ? item.diff_qty = 0 : item.diff_qty = item.item_qty;
          item.sku_barcd = item.sku_barcd ? item.sku_barcd : '';
          skuPcs += item.item_qty;
          return item;
        });

        this.pickedSkuCnt = this.items.length;
        this.pickedSkuPcsQty = skuPcs;
        this.inspectionStatus === 'B' || this.inspectionStatus === 'R' ? this.confirmSkuCnt = 0 : this.confirmSkuCnt = this.pickedSkuCnt;
        this.inspectionStatus === 'B' || this.inspectionStatus === 'R' ? this.confirmSkuPcsQty = 0 : this.confirmSkuPcsQty = this.pickedSkuPcsQty;
        this.focusSkuBarcdInput();

        if(this.jobType) {
          this.$['input-section'].style['grid-template'] = '1.1fr / 1.4fr 1fr 1fr 1fr 1.4fr';
          this.skuMinimumWeight = (inspection.box_weight_list[0]).toFixed(0);
          this.skuWeight = (inspection.box_weight_list[1]).toFixed(0);
          this.skuMaximumWeight = (inspection.box_weight_list[2]).toFixed(0);
        } else {
          this.$['input-section'].style['grid-template'] = '1.1fr / 1.4fr 1fr 1fr 1fr';
        }
      }

      /**
       * 검수 완료 결과 변경 핸들러
       *****************
       * @param {Object} inspectionResult
       */
      _inspectionResultChanged(inspectionResult) {
        this.set('items', []);
        this.currentOrderId = '';
        this.currentBucketCd = '';
        this.pickedSkuCnt = 0;
        this.pickedSkuPcsQty = 0;
        this.confirmSkuCnt = 0;
        this.confirmSkuPcsQty = 0;
        this.$['sku-barcode'].value = '';
        this.$['order-cd'].value = '';
        this.$['bucket-cd'].value = '';
        this.skuMinimumWeight = 0;
        this.skuWeight = 0;
        this.skuMaximumWeight = 0;

        this.focusBucketInput();
      }

      /**
       * 검수 리스트가 configured 될 때 호출 되며
       * diff_qty가 0이면 complete 클래스를 로우에 추가함
       * mps-list의 header 설정에 의해 결정된 color를 제거함
       */
      _addCompleteClass(event) {
        let list = event.detail.contentElements;
        list.forEach(row => {
          let data = row.getData();
          if(data.diff_qty <= 0) {
            row.classList.add('complete')
            let columns = Array.from(row.querySelectorAll('span.data-item'));
            columns.forEach(column => {
              column.style.color = '';
            })
          }
        });
      }

      /**
       * 검수 완료
       */
      completeInspection() {
        // 1. 모두 확인하였다면 검수 완료
        if(this.pickedSkuCnt > 0 && this.confirmSkuCnt > 0 && this.pickedSkuCnt > 0 && this.confirmSkuCnt > 0 &&
           this.pickedSkuCnt == this.confirmSkuCnt && this.pickedSkuPcsQty == this.confirmSkuPcsQty) {
          var completeAjax = this.$['inspection-complete-ajax'];
          completeAjax.curl = '/kiosk_process/dps/inspection/by_qty/finish/' + this.currentOrderId;
          completeAjax.customParams = {
            printer_id: LOGIS_UTIL.getKioskPrinterId()
          };
          completeAjax.generateRequest();
        }
        // 2. 하나라도 검수한 다음 검수 완료 버튼을 누르면 송장 분할--> 박스는 제투입하지 않을 것이기에 박스가 전체 완료되어야 함.
        // else if(this.confirmSkuPcsQty > 0 && this.pickedSkuPcsQty > this.confirmSkuPcsQty) {
        //   this.showMessage(t('button.confirm'), '송장 분할하시겠습니까?', this.splitBox.bind(this));
        //
        // }
        // 3. 검수 완료되지 않았다면 에러 메시지 표시
        else {
          this.showMessage(t('button.confirm'), t('text.inspection_not_finished_yet'), this.focusBucketInput.bind(this));
        }
        // try {
        //   this.validateBeforeComplete();
        //   var completeAjax = this.$['inspection-complete-ajax'];
        //   completeAjax.curl = '/kiosk_process/dps/inspection/by_qty/finish/' + this.currentOrderId;
        //   completeAjax.generateRequest();
        // } catch (error) {
        //   this.showMessage(error.title, error.message, error.confirmCallback);
        // }
      }

      /**
       * 검수 완료 전 Validation Check
       */
      /*validateBeforeComplete() {
        if(this.pickedSkuCnt > 0 &&
           this.confirmSkuCnt > 0 &&
           this.pickedSkuCnt > 0 &&
           this.confirmSkuCnt > 0 &&
           this.pickedSkuCnt == this.confirmSkuCnt &&
           this.pickedSkuPcsQty == this.confirmSkuPcsQty) {
        } else {
          throw {
            title: t('button.confirm'),
            message: t('text.inspection_not_finished_yet'),
            confirmCallback: this.focusBucketInput.bind(this)
          }
        }
      }*/

      /**
       * 초기화
       */
      reset() {
        if(this.items && this.items.length) {
          this.items = this.items.map((item) => {
            if(this.prevSkuBarcode == item.sku_cd || this.prevSkuBarcode == item.sku_barcd) {
              if(item.diff_qty == 0) {
                this.confirmSkuCnt = this.confirmSkuCnt - 1;
              }

              this.confirmSkuPcsQty = this.confirmSkuPcsQty - item.confirm_qty;
              item.confirm_qty = 0;
              item.diff_qty = item.item_qty - item.confirm_qty;
            }

            return item;
          });
        }

        this.$['sku-barcode'].value = '';
        if(this.$['bucket-cd'].value) {
          this.focusSkuBarcdInput();
        } else {
          this.focusBucketInput();
        }
      }

      /**
       * 전체 초기화
       */
      resetAll() {
        if(this.items && this.items.length) {
          this.items = this.items.map((item) => {
            item.confirm_qty = 0;
            item.diff_qty = item.item_qty - item.confirm_qty;
            return item;
          });
        }

        this.$['sku-barcode'].value = '';
        this.confirmSkuCnt = 0;
        this.confirmSkuPcsQty = 0;

        if(this.$['bucket-cd'].value) {
          this.focusSkuBarcdInput();
        } else {
          this.focusBucketInput();
        }
      }

      /**
       * 재발행
       */
      reprint() {
        // 검수가 완료되었다면 재발행을 호출할 수 있다.
        if(this.inspectionStatus === 'E' || this.inspectionStatus === 'S'){
          var reprintAjax = this.$['reprint-invoice-ajax'];
          reprintAjax.curl = '/kiosk_process/dps/inspection/print/' + this.currentOrderId;
          reprintAjax.customParams = {
            printer_id: LOGIS_UTIL.getKioskPrinterId()
          };
          reprintAjax.generateRequest();
        } else {
          this.showMessage(t('button.confirm'), t('text.reprint_error_msg_1'), this.focusBucketInput.bind(this));
        }
      }

      /**
       * 재발행 후 호출되는 리스너
       */
      _reprintSucceed(e) {
        if(e.detail.result.toLowerCase() === 'ok'){
          this.inspectionStatus = '';
          this._inspectionResultChanged();
        } else {
          // 재발행 실패했을 경우
          this.showMessage(t('button.confirm'), t('text.reprint_event_listener_error'), this.focusBucketInput.bind(this));
        }
      }

      /**
       * 송장 분할
       */
      splitBox() {
        var splitBoxAjax = this.$['split-box-ajax'];
        splitBoxAjax.curl = '/kiosk_process/dps/inspection/split_box/' + this.currentOrderId;
        splitBoxAjax.body = this.items;
        splitBoxAjax.generateRequest();
      }

      /**
       * 송장 분할 완료 후
       */
      _splitBoxResponsed(event) {
        var newBox = event.detail;
        this.resetAll();
        this.showMessage(t('button.confirm'), t('text.split_invoice_complete'), function() {
          this.refreshInspection(newBox.box_id);
        }.bind(this));
      }

      /**
       * 라디오 버튼 클릭시
       ****************
       * @param {Object} e
       */
      _handleInspectionMethodClick(e) {
        this.inspectionMethodValue = e.currentTarget.value;
      }

      /**
       * Warning 팝업 표시
       ******************
       * @param {String} title
       * @param {String} message
       */
      showMessage(title, message, confirmCallback) {
        openAlert({
          title: title,
          message: message,
          confirmCallback: confirmCallback
        });
      }

      /**
       * 화면 정보 클리어
       */
      clearView() {
        this.set('items', []);
        this.$['sku-barcode'].value = '';
        this.$['bucket-cd'].value = '';
        this.$['order-cd'].value = '';
        this.confirmSkuCnt = 0;
        this.confirmSkuPcsQty = 0;
        this.pickedSkuCnt = 0;
        this.pickedSkuPcsQty = 0;
        this.currentBucketCd = '';
      }

      /**
       * bucket-cd input field select
       */
      focusBucketInput() {
        this.$['bucket-cd'].select();
      }

      /**
       * order-cd input field select
       */
      focusOrderInput() {
        this.$['order-cd'].select();
      }

      /**
       * sku-barcode input field select
       */
      focusSkuBarcdInput() {
        this.$['sku-barcode'].select();
      }
      /**
       * SKU 정보 조회 시 복수개가 조회된 경우 사용자가 고를 수 있는 버튼이 실행되는데 그 버튼에 표시할 내용
       *******************
       * @param {Object} item
       */
       _skuButtonTxtCallback(item) {
        return `(${item.sku_cd})
                ${item.sku_nm}`;
      }

      /**
       * when sbs button clicked
       */
      searchSBS(e) {
        var sbsUrl = 'http://128.10.1.128/source/report/open_gdc_o.asp?orderid=' + this.custOrderId;
        window.open(sbsUrl, 'SBS');
      }
      changeInspectionStatus(){
        var boxId = this.$['bucket-cd'].value;
        var inputType = LOGIS_UTIL.getKioskInputType();
        var changeStatusAjax = this.$['change-status-ajax'];
        changeStatusAjax.curl = '/kiosk_process/dps/inspection/by_qty/again/'+inputType+'/'+boxId;
        changeStatusAjax.generateRequest();
      }
    }

    customElements.define(KioskDpsInspection.is, KioskDpsInspection);
  </script>

</dom-module>
