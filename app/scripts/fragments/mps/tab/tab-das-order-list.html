<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../tablet-libraries.html">
<link rel="import" href="../../../mixins/mps/mps-common-popup-mixin.html">

<!--
  태블릿 - DAS 호기상품정보 화면
-->

<dom-module id="tab-das-order-list">
  <template>
    <style>
      #container {
        display: flex;
        flex-direction: column;
        height: calc(100% - 40px);
        padding: 20px;
      }
      #button-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        justify-content: end;
        margin-top: 15px;
      }
      button {
        @apply --operator-default-btn;
      }
      button:active {
        @apply --operator-default-btn-active;
      }
      button:focus{
        outline:none
      }

      div.summary {
        /* font-size: var(--operator-default-btn); */
        font-size: .8rem;
        padding: 10px 10px 0px 0px;
        /* border: 1px dashed black; */
      }

      span.qty {
        /* margin: auto !important; */
        float: right;
      }
    </style>

    <!-- 호기별 상품 투입 리스트 Ajax -->
    <sys-ajax
      auto
      id="input-list-ajax"
      method="GET"
      content-type="application/json"
      last-response="{{items}}">
    </sys-ajax>

    <sys-ajax
      id="input-details-ajax"
      method="GET"
      content-type="application/json">
    </sys-ajax>

    <div id="container">
      <!-- 호기별 투입 상품 투입 리스트 표시 영역 -->
      <mps-list
        id="order-list"
        header="[[header]]"
        data="[[items]]"
        on-configured="_addCompleteAttribute"
        on-data-list-click="_skuSelected">
      </mps-list>

      <!-- 버튼 표시 영역 -->
      <div id="button-container">
        <div class="summary" style="color: white;">
          <span>[[labelUndoOrderQty]]</span>
          <span class="qty">[[undoOrderQty]]</span>
        </div>
        <button on-click="refresh">[[refreshBtnLabel]]</button>
      </div>
    </div>
  </template>

  <script>
    class TabDasOrderList extends Polymer.Element {
      static get is() { return 'tab-das-order-list' }

      static get properties() {
        return {
          labelUndoOrderQty: {
            value: () => { return t('label.unfinished_qty'); }
          },

          undoOrderQty: {
            value: 0
          },

          /**
           * @description iron-pages에서 이 화면의 표시 여부
           ****************
           * @type {Boolean}
           */
          visible: {
            type: Boolean,
            observer: '_visibleChanged'
          },

          /**
           * @description 이 화면의 라우팅 URL
           ****************
           * @type {String}
           */
          routingUrl: {
            type: String
          },

          /**
           * @description 새로 고침 버튼 라벨
           ****************
           * @type {Array}
           */
          refreshBtnLabel: {
            type: String,
            value: () => t('button.refresh')
          },

          /**
           * @description 그리드 헤더 정보
           ****************
           * @type {Array}
           */
          header: {
            type: Array,
            value: function() {
              return [{
                display: t('label.sku'),
                fieldname: 'sku_cd_widt_seq',
                displayCallback: (value, rowData) => {
                  if (rowData && rowData['input_seq'] > 0) {
                    return `(${rowData['input_seq']}) ${rowData['sku_nm']}`
                  } else {
                    return `${rowData['sku_nm']}`
                  }
                }
              }, {
                display: t('label.customer'),
                fieldname: 'cust_cnt',
                columnWidth: '0.15fr',
                style: {
                  textAlign: 'center'
                }
              }, {
                display: t('label.picked_qty') + ' / ' + t('label.pick_qty'),
                fieldname: 'total_pick_qty',
                columnWidth: '0.25fr',
                style: {
                  textAlign: 'center'
                },
                displayCallback: (value, rowData) => {
                  return rowData['picked_qty'] + '/' + rowData['pick_qty'];
                }
              }, {
                fieldname: 'com_cd',
                hidden: true
              }, {
                fieldname: 'sku_cd',
                hidden: true
              }, {
                fieldname: 'sku_nm',
                hidden: true
              }, {
                fieldname: 'input_seq',
                hidden: true
              }, {
                fieldname: 'picked_qty',
                hidden: true
              }, {
                fieldname: 'pick_qty',
                hidden: true
              }, {
                fieldname: 'status',
                hidden: true
              }];
            }
          },

          detailFormFields: {
            type: Array,
            value: () => [{
              name: 'sku_cd',
              display: t('label.sku_cd'),
              styles: {
                textAlign: 'right'
              }
            }, {
              name: 'sku_nm',
              display: t('label.sku_nm'),
              styles: {
                textAlign: 'right'
              }
            }, {
              name: 'total_pick_qty',
              display: t('label.picked_qty') + ' / ' + t('label.pick_qty'),
              styles: {
                textAlign: 'right'
              }
            }]
          },

          detailListFields: {
            type: Array,
            value: () => [{
              display: t('label.location'),
              fieldname: 'loc_cd',
              columnWidth: '0.2fr'
            }, {
              display: t('label.cust_nm'),
              fieldname: 'cust_nm',
              columnWidth: '0.6fr'
            }, {
              display: t('label.picked_qty') + ' / ' + t('label.pick_qty'),
              fieldname: 'display_qty',
              columnWidth: '0.2fr',
              style: {
                textAlign: 'right'
              },
              displayCallback: (value, rowData) => {
                return `${rowData.picked_qty}/${rowData.pick_qty}`;
              }
            }, {
              fieldname: 'status',
              hidden: true
            }, {
              fieldname: 'picked_qty',
              hidden: true
            }, {
              fieldname: 'pick_qty',
              hidden: true
            }]
          },

          /**
           * @description 그리드 데이터
           ****************
           * @type {Array}
           */
          items: {
            type: Array,
            observer: '_itemsChanged'
          }
        }
      }

      /**
       * @description connectedCallback
       */
      connectedCallback() {
        super.connectedCallback();

        // 현재 페이지의 URL을 저장
        this.routingUrl = location.hash.replace('#/', '');

        // 해더의 refresh button 클릭시 발생하는 refresh-view-[route] event handler
        document.addEventListener(`refresh-view-${this.routingUrl}`, event => {
          this.refresh();
        });

        this.refresh();
      }

      /**
       * @description 이 화면의 표시 상태가 바뀔 때 handle
       */
      _visibleChanged(visible) {
        if(visible) {
          this.refresh();
        }
      }

      /**
       * @description 데이터가 완료되었는지 체크
       ****************
       * @type {Object} data
       */
      isComplete(data) {
        return data.picked_qty >= data.pick_qty;
      }

      _itemsChanged(items) {
        if(!items || items.length <= 0) return;
        var undoOrderQty = 0;
        items.forEach((item) => {
          if (!this.isComplete(item)) {
            undoOrderQty++;
          }
        });

        this.undoOrderQty = undoOrderQty;
      }

      /**
       * @description 데이터 변경시
       *******************
       * @param {Array} items
       */
      refresh() {
        let regionCd = ANY_UTIL.getRegionCd();
        let zoneCd = ANY_UTIL.getZoneCd();
        let sideCd = ANY_UTIL.getSideCd();
        const inputListAjax = this.$['input-list-ajax'];
        inputListAjax.curl = `/tablet_process/input_status/${regionCd}/${zoneCd}/${sideCd}`;

        if(inputListAjax.baseUrl) {
          // 최초 호출이 아닌 baseUrl이 있는 경우에는 명시적으로 generateRequest를 호출함
          inputListAjax.generateRequest();
        }
      }

      /**
       * @description back-btn click event handler
       * 이전 페이지로 이동
       */
      goBack() {
        history.back();
      }

      /**
       * @description 리스트의 데이터 상태에 따라 행의 색상을 변경
       * R: Running 진행중, F: Finished 완료, U: Unfinished 미완료 (취소 건이 포함되어 있어서 완료되지 않은 상태)
       ****************
       * @type {Object} event
       */
       _addCompleteAttribute(event) {
        const rows = event.detail.contentElements;
        rows.forEach(row => {
          const status = row.getData().status;
          if(status === 'F') { // 완료 상태
            row.classList.add('complete');
          } else if(status === 'U') { // 미완료 상태
            row.classList.add('canceled');
          } else if (status === 'C') {
            row.classList.add('canceled');
          }
        });
      }

      /**
       * @description 리스트 아이템 클릭 이벤트 핸들러
       * 선택한 상품의 거래처별 요약 정보 팝업 실행
       ***********************
       * @param {Object} event
       */
      _skuSelected(event) {
        const regionCd = ANY_UTIL.getRegionCd();
        const zoneCd = ANY_UTIL.getZoneCd();
        const sideCd = ANY_UTIL.getSideCd();
        const comCd = event.detail.data.com_cd;
        const skuCd = event.detail.data.sku_cd;
        const skuNm = event.detail.data.sku_nm;

        document.dispatchEvent(new CustomEvent('open-form-list-dialog', {
          detail: {
            formFields: this.detailFormFields,
            listFields: this.detailListFields,
            formData: event.detail.data,
            listDataReqUrl: `/tablet_process/das/input_status_details/${regionCd}/${zoneCd}/${sideCd}/${comCd}/${skuCd}`,
            handleFormDataBeforeSet: params => {
              const formData = params.formData;
              formData.total_pick_qty = `${formData.picked_qty} / ${formData.pick_qty}`;
            },
            handleListDataAfterSet: params => {
              const rows = params.listElement.getRows();
              rows.forEach(row => {
                let rowData = row.getData();
                let pickQty = parseInt(rowData.pick_qty);
                let pickedQty = parseInt(rowData.picked_qty);
                if(pickQty === pickedQty || rowData.status === 'F') {
                  row.classList.add('complete');
                } else if (rowData.status === 'C') {
                  row.classList.add('canceled');
                }
              });
            }
          }
        }));
      }
    }

    customElements.define(TabDasOrderList.is, TabDasOrderList);
  </script>
</dom-module>
