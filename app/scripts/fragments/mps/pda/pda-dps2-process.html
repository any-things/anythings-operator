<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../../mixins/logis/logis-msg-subscribe-mixin.html">

<link rel="import" href="../../../../components/common/barcode-field.html">

<link rel="import" href="../../../../components/loigs/adjust-qty-popup.html">
<link rel="import" href="../../../../components/logis/box-process-checker.html">
<link rel="import" href="../../../../components/logis/plan-actual-display.html">
<link rel="import" href="../../../../components/logis/job-list.html">
<link rel="import" href="../../../../components/logis/indicator-inspector.html">
<link rel="import" href="../../../../components/logis/cell-box-mapper-popup.html">

<!--
  PDA > DPS 2차 분류 작업 처리 화면
-->
<dom-module id="pda-dps2-process">
  <template>
    <style include="shared-styles">
      :host {
        display: flex;
        flex-direction: column;
        padding: 10px;
        height: calc(100% - 20px);
      }
      #container {
        display: flex;
        flex-direction: column;
        flex: 1;
        padding: 5px;
        background-color: var(--things-white-opacity-background-color);
        border-radius: var(--things-default-border-radius);
        color: rgba(255,255,255,.8);
      }
      #rack-info-container {
        display: flex;
        font-size: .8rem;
        border-bottom: 1px solid rgba(255,255,255,.2);
      }
      #rack-info-container label, #rack-info-container span{
        flex: 1;
        text-align: center;
      }
      #input-container {
        display: flex;
        flex-direction: column;
      }
      .input-row {
        display: flex;
        flex-direction: row;
        margin-bottom: 5px;
      }
      .input-row .label {
        font-size:.8rem;
        margin: 5px 5px auto auto;
        min-width: 25%;
        text-align: right;
      }
      .input-row input, auto-popup-input {
        width: 75%;
      }

      item-list{
        flex: 1;
      }
      #total-qty {
        display: grid;
        grid-template-columns: 2fr 1fr;
        margin-top: 5px;
        background-color:rgba(204, 5, 5, 0.2);
        border-radius:var(--things-default-border-radius);
        font-size: .8rem;
        padding: 5px 5px 5px 5px
      }
      #total-qty span {
        margin-left: 15px;
      }
      #total-qty span.qty {
        margin: auto !important;
      }

      button {
        --operator-default-btn: {
        background: #626262;
        border: none;
        border-radius:12px;
        margin:0;padding:.3rem 1rem;
        min-width:100px;
        color: #fff;
        font-size:.8rem;
        font-family: "Noto Sans KR";
        outline: none;
        }
      }

      .col2 {
        margin-top: 2px;
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    </style>

    <!-- 상품 투입 전 상품 정보 조회를 위한 Ajax -->
    <sys-ajax
      id="find-sku-ajax"
      method="GET"
      content-type="application/json"
      last-response="{{findSkuResponse}}"
      on-sys-ajax-error="_handleFindAjaxError">
      <!-- on-sys-ajax-response="_handleFindSkuResponse"> -->
    </sys-ajax>

    <!-- 상품 투입 트랜잭션을 위한 Ajax -->
    <sys-ajax
      id="input-sku-ajax"
      method="POST"
      content-type="application/json"
      last-response="{{inputSkuResponse}}">
    </sys-ajax>

    <!-- 상품 정보 스캔 투입 리스트 -->
    <sys-ajax
      auto
      id="input-list-ajax"
      method="GET"
      content-type="application/json"
      last-response="{{inputListResponse}}">
    </sys-ajax>

    <!-- 투입 이벤트의 거래처 작업 리스트 -->
    <sys-ajax
      id="input-job-details-ajax"
      method="GET"
      curl="/tablet_process/job_details/:rack_cd/:side_cd/:zone_cd/:com_cd/:sku_cd"
      content-type="application/json"
      last-response="{{inputDetails}}">
    </sys-ajax>

    <!-- 슈트 정보 조회 Ajax -->
    <sys-ajax
      id="chute-info-ajax"
      method="GET"
      content-type="application/json"
      on-sys-ajax-response="_chuteInfoResponse">
    </sys-ajax>

    <!-- 화면 컨테이너 -->
    <div id="container">
      <!-- 랙 정보 -->
      <div id="rack-info-container" class="input-row">
        <label>[[rackNmLabel]]</label>
        <span id="view-rack-nm">[[rackNm]]</span>
        <label>[[zoneCdLabel]]</label>
        <span id="view-zone-nm">[[zoneCd]]</span>
      </div>

      <div id="input-container">
        <!-- 상품 코드 혹은 상품 바코드 입력 컴포넌트 행 -->
        <barcode-field id="input" timeout="2000" value="{{skuBarCd}}"
          button-text-callback="[[_skuButtonTextCallback]]" selected-item="{{findSkuResponse}}"
          on-keypress="_handleBarcodeKeypress">
        </barcode-field>

        <!-- 상품 코드 표시 컴포넌트 행 -->
        <div class="input-row">
          <span class="label">[[skuCdLabel]]</span>
          <input id="sku-cd" value$="[[skuCd]]" readonly>
        </div>

        <!-- 상품 명 표시 컴포넌트 행 -->
        <div class="input-row">
          <span class="label">[[skuNmLabel]]</span>
          <input id="sku-nm" value="[[skuNm]]" readonly>
        </div>

        <!-- 고객사 코드 정보를 간직하기 위한 컴포넌트 행 -->
        <input id="com-cd" hidden>

        <!-- 상품의 입수 수량 표시 컴포넌트 행 -->
        <input id="box-in-qty" hidden>
      </div>

      <!-- 작업 리스트 표시를 위한 컴포넌트 -->
      <job-list
        header="[[header]]"
        items="[[items]]"
        job-type="DAS"
        is-data-polution="{{isDataPolution}}">
      </job-list>

      <!-- 총 수량 표시를 위한 컴포넌트 -->
      <plan-actual-display
        cust-cd-qty="[[custCdQty]]"
        picked-qty="[[_computeSkuPickedQty(totalPickedQty)]]"
        pick-qty="[[_computeSkuPickQty(totalPickQty)]]">
      </plan-actual-display>
    </div>

    <div class="col2">
      <!-- 버튼 리스트 -->
      <button active$="[[todoBtnActive]]" on-click="_clickMpiOnTodoJobs">[[relightBtnLabel]]</button>
      <button on-click="refreshInputList">[[refreshBtnLabel]]</button>
      <!--button active$="[[inspectBtnActive]]" on-click="_clickInspectMode">[[inspectBtnLabel]]</button-->
    </div>

    <!-- 박스 검수 컴포넌트 -->
    <box-process-checker
      id="inspect-box"
      rack-cd="[[rackCd]]">
    </box-process-checker>

    <!-- 로케이션 - 박스 매핑 컴포넌트 -->
    <cell-box-mapper-popup
      rack-cd="[[rackCd]]"
      input-value="{{inputValue}}"
      on-need-inspect-box="_handleNeedInspectBox">
    </cell-box-mapper-popup>

    <!-- 검수 On/Off 버튼 컴포넌트 -->
    <indicator-inspector
      is-on-todo="[[todoBtnActive]]"
      is-inspect-mode="[[inspectBtnActive]]"
      com-code="[[comCd]]"
      sku-code="[[skuCd]]">
    </indicator-inspector>

  </template>

  <script>
    class PdaDps2Process extends LogisMsgSubscribeMixin(Polymer.Element) {
      static get is() {
        return 'pda-dps2-process'
      }

      static get properties() {
        return {
          /**
           * @description 화면이 표시되는 이벤트시 처리하기 위한 변수
           *******************************
           * @type {Boolean}
           */
          visible: {
            type: Boolean,
            observer: '_visibleChanged'
          },

          /**
           * @description SKU 정보 조회 시 복수개가 조회된 경우 사용자가 고를 수 있는 팝업이 실행되는데 그 팝업에 표시할 타이틀
           ****************
           * @type {String}
           */
          popupTitleLabel: {
            type: String,
            value: () => t('label.sku')
          },

          /**
           * @description 버튼 리스트 팝업 표시를 위한 버튼 라벨
           ****************
           * @type {String}
           */
          showBtnsPopup: {
            type: String,
            value: () => t('button.show_button')
          },

          /**
           * @description 재점등 버튼 라벨
           ****************
           * @type {String}
           */
          relightBtnLabel: {
            type: String,
            value: () => t('button.relight')
          },

          /**
           * @description 검수 버튼 라벨
           ****************
           * @type {String}
           */
          inspectBtnLabel: {
            type: String,
            value: () => t('button.product_inspect')
          },

          /**
           * @description 초기화 버튼 라벨
           ****************
           * @type {String}
           */
          refreshBtnLabel: {
            type: String,
            value: () => t('button.refresh')
          },

          /**
           * @description 상품 코드 라벨
           ****************
           * @type {String}
           */
          barcodeLabel: {
            type: String,
            value: () => t('label.barcode')
          },

          /**
           * @description 상품 코드 라벨
           ****************
           * @type {String}
           */
          skuCdLabel: {
            type: String,
            value: () => t('label.sku_cd')
          },

          /**
           * @description 상품 명 라벨
           ****************
           * @type {String}
           */
          skuNmLabel: {
            type: String,
            value: () => t('label.sku_nm')
          },

          /**
           * @description 고객사 수 라벨
           ****************
           * @type {String}
           */
          custCntLabel: {
            type: String,
            value: () => t('label.cust_cnt')
          },

          /**
           * @description 투입 결과
           ****************
           * @type {Object}
           */
          jobResult: {
            type: Object,
            observer: '_jobResultChanged'
          },

          /**
           * @description 그리드 데이터
           ****************
           * @type {Array}
           */
          items: {
            type: Array
          },

          /**
           * @description 그리드 헤더
           ****************
           * @type {Array}
           */
          header: {
            type: Array,
            value: function() {
              return [{
                display: t('label.cust_nm'),
                fieldname: 'cust_nm_with_seq',
                displayCallback: (rowData) => {
                  if (rowData.input_seq) {
                    return `(${rowData.input_seq}) ${rowData.cust_nm}`;
                  } else {
                    return `${rowData.cust_nm}`;
                  }
                }
              }, {
                display: t('label.location'),
                fieldname: 'loc_cd',
                columnWidth: '0.33fr',
                style: {
                  textAlign: 'center'
                },
                displayCallback: (rowData) => {
                  return `${rowData.loc_cd.split('-')[1]}`;
                }
              }, {
                display: t('label.picking_qty') + '/' + t('label.picked_qty') + '/' + t('label.pick_qty'),
                fieldname: 'total_qty',
                style: {
                  textAlign: 'center'
                },
                displayCallback: (rowData) => {
                  return `${rowData['picking_qty']}/${rowData['picked_qty']}/${rowData['pick_qty']}`;
                },
                columnWidth: '0.7fr'
              }, {
                fieldname: 'status',
                hidden: true
              }, {
                fieldname: 'id',
                hidden: true
              }, {
                fieldname: 'picked_qty',
                hidden: true
              }, {
                fieldname: 'picking_qty',
                hidden: true
              }, {
                fieldname: 'pick_qty',
                hidden: true
              }, {
                fieldname: 'cust_nm',
                hidden: true
              }, {
                fieldname: 'input_seq',
                hidden: true
              }];
            }
          },

          /**
           * @description 투입 정보
           ****************
           * @type {String}
           */
          inputValue: {
            type: String,
            observer: '_inputValueChanged'
          },

          /**
           * @description 상품 조회 시 응답
           ****************
           * @type {String}
           */
          findSkuResponse: {
            type: Object,
            observer: '_findSkuResponseChanged'
          },

          /**
           * @description 작업 리스트 중 선택한 항목
           ****************
           * @type {String}
           */
          selectedInput: {
            type: Object,
            observer: '_selectedInputChanged'
          },

          /**
           * @description 상품 투입시 응답
           ****************
           * @type {String}
           */
          inputSkuResponse: {
            type: Object,
            observer: '_inputSkuResponseChanged'
          },

          /**
           * @description 투입 리스트 조회 시 응답
           ****************
           * @type {String}
           */
          inputListResponse: {
            type: Object,
            observer: '_inputListResponseChanged'
          },

          /**
           * @description 투입 리스트
           ****************
           * @type {Array}
           */
          inputList: {
            type: Array,
            observer: '_inputListChanged'
          },

          /**
           * @description 투입 상세 정보
           ****************
           * @type {Array}
           */
          inputDetails: {
            type: Object,
            observer: '_inputDetailsChanged'
          },

          /**
           * @description 랙 코드 라벨
           */
          rackNmLabel: {
            type: String,
            value: () => t('label.rack_nm'),
          },

          /**
           * @description 존 코드 라벨
           */
          zoneCdLabel: {
            type: String,
            value: () => t('label.zone_cd')
          },

          /**
           * @description 총 수량 라벨
           ****************
           * @type {Array}
           */
          totalQtyLabel: {
            type: String,
            value: () => t('label.total_picked_qty') + '/' + t('label.total_picking_qty')
          },

          /**
           * @description 총 확정 수량 라벨
           ****************
           * @type {Array}
           */
          totalPickedQty: {
            type: Number,
            value: 0
          },

          /**
           * @description 총 예정 수량 라벨
           ****************
           * @type {Array}
           */
          totalPickQty: {
            type: Number,
            value: 0
          },

          /**
           * @description 총 확정 박스 수량 라벨
           ****************
           * @type {Array}
           */
          totalPickedBoxPcsQty: {
            type: String
          },

          /**
           * @description 총 예정 박스 수량 라벨
           ****************
           * @type {Array}
           */
          totalPickBoxPcsQty: {
            type: String
          },

          /**
           * ?
           ****************
           * @type {Boolean}
           */
          isDataPolution: {
            type: Boolean,
            observer: '_isDataPolutionChanged'
          },

          /**
           * @description 작업할 랙 코드 표시값
           ****************
           * @type {String}
           */
          rackCd: {
            type: String,
            value: LOGIS_UTIL.getRackCd(),
            observer: '_rackCdChanged'
          },

          /**
           * @description 작업할 랙 명 표시값
           ****************
           * @type {String}
           */
          rackNm: {
            type: String,
            notify: true,
            value: LOGIS_UTIL.getRackNm(),
            observer: '_rackNmChanged'
          },

          /**
           * @description 작업할 존 코드 (슈트) 표시값
           ****************
           * @type {String}
           */
          zoneCd: {
            type: String,
            notify: true,
            value: LOGIS_UTIL.getEquipZone(),
            observer: '_zoneCdChanged'
          }
        }
      }

      /**
       * @description 화면 표시 / 숨김 변동이 생긴 경우
       *********************
       * @param {Boolean} visible
       */
      _visibleChanged(visible) {
        if (visible) {
          this._reset();
          this.refreshInputList();
        }
      }

      /**
       * @description 메시징 서버에서 메시지를 받아 refresh
       *********************
       * @param {Object} data
       */
      refreshByWs(data) {
        if (data == 'details') {
          this.refreshInputDetails();
        }
      }

      /**
       * @description Life Cycle - connected callback
       *********************
       */
      connectedCallback() {
        super.connectedCallback();

        document.addEventListener(`alert-closed-at-${location.hash.replace('#/', '')}`, event => {
          if (!event.detail.hasCallback) {
            this._initFocus();
          }
        });

        // barcode input - focus on
        this._initFocus();
      }

      /**
       * @description 랙 코드 변경 시
       *********************
       * @param {String} rackCd
       */
      _rackCdChanged(rackCd) {
        if (rackCd) {
          window.localStorage.setItem('setting.rackCd', JSON.stringify(rackCd));
        }
      }

      /**
       * @description 랙 명 변경 시
       *********************
       * @param {String} rackNm
       */
      _rackNmChanged(rackNm) {
        if (rackNm) {
          window.localStorage.setItem('setting.rackNm', JSON.stringify(rackNm));
        }
      }

      /**
       * @description 작업 존 코드 변경 시
       *********************
       * @param {String} zoneCd
       */
      _zoneCdChanged(zoneCd) {
        if (zoneCd && this.rackCd) {
          WEB_MQTT.reset(this.rackCd, zoneCd);
          window.localStorage.setItem('setting.equipZone', JSON.stringify(zoneCd));
        }
      }

      /**
       * @description
       *********************
       * @param {Object} isDataPolution
       */
      _isDataPolutionChanged(isDataPolution) {
        if (isDataPolution) {
          this.refreshInputList();
        }
      }

      /**
       * @description 투입 정보 변경시
       *********************
       * @param {Object} isDataPolution
       */
      _inputValueChanged(inputValue) {
        if (!inputValue) return;

        // 표시기 코드 (01로 시작하고 22자) or 로케이션 코드 (- 다음 네자리 숫자) or 박스 ID(16자리) 스캔시 ...
        if ((inputValue.startsWith('01') && inputValue.length === 22) ||
          inputValue.length === 16 ||
          inputValue.search(/-[0-9][0-9][0-9][0-9]$/) >= 0) {
          this._initFocus();

          // 그 외 값은 상품 정보로 판단하여 상품 조회
        } else {
          let ajax = this.$['find-sku-ajax'];
          ajax.curl = `/tablet_process/find_sku/${this.rackCd}/${inputValue}`;
          ajax.generateRequest();
        }
      }

      /**
       * @description 상품 조회 요청 응답시
       *********************
       * @param {Object} findSkuResponse
       */
      _findSkuResponseChanged(findSkuResponse) {
        if (!findSkuResponse || findSkuResponse.length === 0) {
          document.dispatchEvent(new CustomEvent('show-toast', {
            detail: {
              type: t('error.VALIDATION_ERROR'),
              message: t('text.cant_find_result_by_input')
            }
          }));

          this._initFocus();
          return;
        }

        if (findSkuResponse.length > 1) {
          this.$.input.openPopup(findSkuResponse);
          return;
        }

        var selectedInput = findSkuResponse[0];
        this.selectedInput = selectedInput;

        if (!this.inspectBtnActive) {
          // 검수 모드가 아니면 투입 처리
          this.doInputTransaction({
            rackCd: this.rackCd,
            sideCd: this.sideCd,
            comCd: selectedInput.com_cd,
            skuCd: selectedInput.sku_cd,
            boxBarcd: selectedInput.box_barcd
          });
          this._initFocus();
        }
      }

      /**
       * @description 상품 조회 실패시
       ******************
       * @param {Object} event
       */
      _handleFindAjaxError(e) {
        this._reset(true);
      }

      /**
       * @description 투입 리스트에서 특저 항목 선택시
       ******************
       * @param {Object} event
       */
      _selectedInputChanged(selectedInput) {
        this._reset();

        if (selectedInput && selectedInput.sku_cd) {
          this.comCd = selectedInput.com_cd;
          this.skuCd = selectedInput.sku_cd;
          this.skuNm = selectedInput.sku_nm;
          this.orderId = selectedInput.order_id;
        }
      }

      /**
       * @description 상품 투입 리스트 선택 변경시
       ******************
       * @param {Object} inputSkuResponse
       */
      _inputSkuResponseChanged(inputSkuResponse) {
        if (inputSkuResponse && inputSkuResponse.items && inputSkuResponse.items.length > 0) {
          this.refreshInputDetails();
        }
      }

      /**
       * @description 상품 투입 리스트 선택 변경시
       ******************
       * @param {Object} inputSkuResponse
       */
      _inputListResponseChanged(inputListResponse) {
        this.inputList = inputListResponse || [];
        window.SOUND.playInfoSound();
      }

      /**
       * @description 상품 투입 리스트 변경시
       ******************
       * @param {Array} inputList
       */
      _inputListChanged(inputList) {
        if (!inputList || inputList.length === 0) {
          this.selectedInput = JSON.parse(JSON.stringify({}));
        } else {
          /* 아래 로직은 job-progress-bar를 주석처리하면서 추가된 코드임: 첫 진입시 데이터 조회 */
          this.selectedInput = JSON.parse(JSON.stringify(inputList[0]));
          this.refreshInputDetails();
        }
      }

      /**
       * @description 상품 투입 리스트 중 선택된 상품 투입 상세 데이터 변경시
       ******************
       * @param {Array} inputDetails
       * @Override inputDetails data structure변경.
       */
      _inputDetailsChanged(inputDetails) {
        var items = this.sortByStatus(inputDetails);
        this.items = items || [];
        this._updateStatus(inputDetails);
        window.SOUND.playInfoSound();
      }

      /**
       * @description 투입 상품 리스트 조회
       ******************
       * @param {Object} event
       */
      refreshInputList(event) {
        // 버튼 클릭으로 인한 refresh의 경우 event의 type을 click으로 받는다
        // 버튼 클릭의 경우 현재 inputList가 response 되었을 때 현재 inputList와 조회 결과를 비교하지 않고 반드시
        // this.inputList에 값을 초기화 하도록 forceRefresh flag를 true로 변환한다.
        if (event && event.type === 'click') {
          this.forceRefresh = true;
        }

        var {
          rackCd,
          zoneCd,
          sideCd,
          showOthersOrder
        } = this;
        var ajax = this.$['input-list-ajax'];
        ajax.curl = `/tablet_process/input_list/${rackCd}/${zoneCd}/${sideCd}`;
        // 대상 외 작업 조회 여부 param setting
        ajax.customParams = {
          show_others_order: showOthersOrder
        };
      }

      /**
       * @description 상품 리스트 중 선택된 상품 정보 상세 조회
       *********************
       * @param {Boolean} mpiOnFlag 표시기 점등 여부
       * @Override
       */
      refreshInputDetails(mpiOnFlag) {
        let rackCd = this.rackCd;
        let zoneCd = this.zoneCd;
        let sideCd = LOGIS_UTIL.getRackSide();
        let comCd = this.comCd ? this.comCd : '_na_';
        let skuCd = this.skuCd ? this.skuCd : '_na_';
        let headerColor = this.selectedInput ? this.selectedInput.mpi_color : 'Y';

        // skuCd가 없으면 detail을 호출하지 않음.
        if (skuCd === '_na_') return;

        try {
          this.validationBeforeRefreshDetail(zoneCd, sideCd);
          let detailAjax = this.$['input-job-details-ajax'];
          detailAjax.curl = `/tablet_process/job_details/${rackCd}/${sideCd}/${zoneCd}/${comCd}/${skuCd}`;
          detailAjax.generateRequest();
        } catch (error) {
          LOGIS_UTIL.showMessage(error.title, error.message, error.callback);
        }
      }

      /**
       * @description 확정 수량
       *********************
       * @param {Number} pickedQty 예정 수량
       */
      _computeSkuPickedQty(pickedQty) {
        return this._calcBoxPcsQty(pickedQty);
      }

      /**
       * @description 예정 수량
       *********************
       * @param {Number} pickQty 예정 수량
       */
      _computeSkuPickQty(pickQty) {
        return this._calcBoxPcsQty(pickQty);
      }

      /**
       * @description 박스/낱개 수량 계산
       *********************
       * @param {Number} pcsQty 낱개 수량
       */
      _calcBoxPcsQty(pcsQty) {
        pcsQty = pcsQty || 0;
        var boxInQty = this.boxInQty || 1;
        var boxPcsStr = Math.floor(pcsQty / boxInQty);
        boxPcsStr += '-';
        boxPcsStr += (pcsQty % boxInQty).toFixed(0);
        return boxPcsStr;
      }

      /**
       * @description 상품 투입 상세 정보로 현황 정보 리프레쉬
       ******************
       * @param {Array} inputDetails
       */
      _updateStatus(inputDetails) {
        if (!inputDetails) return;

        var custCds = [];

        inputDetails.forEach((obj) => {
          if (custCds.indexOf(obj.cust_cd) < 0) {
            custCds.push(obj.cust_cd);
          }

          // inputDetails는 한 개 제품 스캔 이력만 조회함.
          if (this.boxInQty != obj.box_in_qty) {
            this.boxInQty = obj.box_in_qty;
          }
        }, this);

        this.custCdQty = custCds.length;
        let totalPickQty = 0; // 총 주문 수량
        let totalPickedQty = 0; // 총 확정 수량
        let canceledQty = 0; // 작업 취소된 상품 수량

        inputDetails.forEach(item => {
          totalPickQty += item.pick_qty;
          totalPickedQty += item.picked_qty;
          if (item.status === 'C') { // FIXME
            canceledQty += item.pick_qty;
          }
        });

        this.totalPickQty = totalPickQty;
        this.totalPickedQty = totalPickedQty;
      }

      /**
       * @description 상품 투입 api 호출
       ******************
       * @param {Array} params
       */
      doInputTransaction(params) {
        var {
          rackCd,
          sideCd,
          comCd,
          skuCd,
          boxBarcd
        } = params || this;

        try {
          this.validateBeforeRequest();
        } catch (error) {
          openAlert({
            title: t('error.VALIDATION_ERROR'),
            message: error,
            confirmCallback: () => {
              this._initFocus();
            }
          });
          return;
        }

        var inputAjax = this.$['input-sku-ajax'];
        // 연속 스캔 허용 여부 설정에서 조회
        var isContinousScanAllowed = LOGIS_UTIL.isContinousScanAllowed();

        // 마지막으로 스캔한 코드가 박스 바코드이면 박스째 투입으로 처리
        if (this.inputValue === boxBarcd) {
          inputAjax.curl = `/pda_process/box_input/${rackCd}/${sideCd}/${this.zoneCd}/${comCd}/${skuCd}?allow_continous_scan=${isContinousScanAllowed}`;
          // 그렇지 않으면 단일 상품 투입
        } else {
          inputAjax.curl = `/pda_process/input_sku/${rackCd}/${sideCd}/${this.zoneCd}/${comCd}/${skuCd}?allow_continous_scan=${isContinousScanAllowed}`;
        }

        inputAjax.generateRequest();
      }

      /**
       * @description 스캔한 상품 바코드로 조회한 결과 상품이  하나 이상인 경우 버튼 텍스트를 표시
       *********************
       * @param {Object} item
       */
      _skuButtonTextCallback(item) {
        return `(${item.sku_cd})
                ${item.sku_nm}`;
      }

      /**
       * @description 상품 정보 상세 정보 리프레쉬 전 Validation Check
       *********************
       * @param {Boolean} zoneCd 표시기 점등 여부
       * @param {Boolean} sideCd 랙 사이드 코드
       */
      validationBeforeRefreshDetail(zoneCd, sideCd) {
        if (!zoneCd) {
          throw {
            title: t('error.SETTING_ERROR'),
            message: t('text.zone_code_is_not_set'),
            callback: this.moveToSetting
          }
        }

        if (!sideCd) {
          throw {
            title: t('error.SETTING_ERROR'),
            message: t('text.rack_side_is_not_set'),
            callback: this.moveToSetting
          }
        }
      }

      /**
       * @description 상품 정보 조회 전 수행하는 validation
       *********************
       */
      validateBeforeRequest() {
        let skuCd = this.skuCd;

        if (!skuCd || skuCd.length < 4) {
          throw t('error.sku_barcd_invalid');
        }
      }

      /**
       * @description 상품 바코드 박스에서 엔터 이벤트 발생시
       *********************
       * @param {Object} e 엔터 이벤트
       */
      _handleBarcodeKeypress(e) {
        if (e.keyCode != 13) return;

        // 슈트 넘버 스캔시 처리
        var value = this.$.input.getValue();
        if (/^\d{3}$/.test(value)) {
          this.chuteNumberScanned(value);
        } else {
          this.inputValue = null;
          this.inputValue = value;
        }
      }

      /**
       * @description 슈트 번호가 스캔되었을때 유효한 슈트 정보인지 조회
       *********************
       * @param {Number} chuteNumber 슈트 번호
       */
      chuteNumberScanned(chuteNumber) {
        const chuteInfoAjax = this._getChuteInfoAjax();
        chuteInfoAjax.curl = `/pda_process/chute_info/${chuteNumber}`;
        chuteInfoAjax.generateRequest();
      }

      /**
       * @description 유효한 슈트 번호에 대한 response가 오면 화면 정보를 업데이트하고 clear
       *********************
       * @param {Object} event
       */
      _chuteInfoResponse(event) {
        this.rackNm = event.detail.rack_nm;
        this.rackCd = event.detail.rack_cd;
        this.zoneCd = event.detail.chute_no;
        showToast('info', `${t('text.chute_changed')}`);
        this._reset();
      }

      /**
       * @description 슈트 정보 조회를 위한 AJAX 객체 리턴
       *********************
       * @return
       */
      _getChuteInfoAjax() {
        return this.$['chute-info-ajax'];
      }

      /**
       * @description 유효한 슈트 번호에 대한 response가 오면 화면 정보를 업데이트하고 clear
       *********************
       * @param {Object} event
       */
      _clickMpiOnTodoJobs(event) {
        this.todoBtnActive = !this.todoBtnActive;
        this._initFocus();
      }

      /**
       * @description 유효한 슈트 번호에 대한 response가 오면 화면 정보를 업데이트하고 clear
       *********************
       * @param {Object} event
       */
      _clickInspectMode(event) {
        this.inspectBtnActive = !this.inspectBtnActive;
        this._initFocus();
      }

      /**
       * @description 미들웨어로부터 메시지 처리
       ******************
       * @param {String} type
       * @param {String} title
       * @param {String} message
       * @param {Function} confirmCallback
       */
      showMessage(type, title, message, confirmCallback) {
        switch (type) {
          case 'error':
            {
              MsgAlert.webAlert({
                title: title,
                message: message,
                confirmText: t('button.cancel')
              });
            }
            break;
          case 'info':
          default:
            {
              showToast(type, message);
            }
        }

        window.SOUND.playInfoSound();
      }

      /**
       * @description  박스 검수 요청
       **********************
       * @param {Object} e
       */
      _handleNeedInspectBox(e) {
        if (e && e.detail) {
          var boxId = e.detail.boxId;
          var inspectBox = this.$['inspect-box'];
          inspectBox.getBoxInfo(boxId);
        }
      }

      /**
       * @description 화면 리셋
       ******************
       */
      _reset(isItemReset) {
        this.rackCd = this.rackCd;
        this.zoneCd = this.zoneCd;
        this.sideCd = LOGIS_UTIL.getRackSide();
        this.showOthersOrder = false;

        this.skuBarcd = '';
        this.skuCd = '';
        this.skuNm = '';

        if (isItemReset) {
          this.set('items', []);
        }

        this._initFocus();
      }

      /**
       * @description 초기 셋업
       ******************
       */
      _initFocus() {
        // this.$.input.focus();
        this.$.input.select();
      }

      /**
       * @description 작업 리스트 소팅
       *********************
       * @param {Array} items 작업 리스트
       */
      sortByStatus(items) {
        if (!items || items.length === 0) {
          return;
        }

        var doingList = items.filter((item) => {
          return item.status != 'W' && item.status != 'F';
        });
        var waitList = items.filter((item) => {
          return item.status == 'W';
        });
        var finishList = items.filter((item) => {
          return item.status == 'F';
        });
        var list = doingList || [];

        if (waitList || waitList.length) {
          list = list.concat(waitList);
        }

        if (finishList || finishList.length) {
          list = list.concat(finishList);
        }

        return list;
      }
    }

    customElements.define(PdaDps2Process.is, PdaDps2Process);
  </script>
</dom-module>
